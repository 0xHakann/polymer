<!doctype html>
<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>Polymer - setProperties</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../src/events/gesture-event-listeners.html">
  <link rel="import" href="../../src/template/template-stamp.html">
  <link rel="import" href="../../src/properties/batched-effects.html">
  <link rel="import" href="../../src/attributes/attribute-to-from-property.html">

</head>
<body>

  <template id="x-template">
    <style>
      :host {
        display: block;
        background: beige;
        padding: 8px;
        margin: 4px;
      }
      td:first-of-type {
        background: lightgray;
      }
    </style>
    <table>
      <tr><td foo$="{{foo}}" title="{{foo}}">foo:</td><td>{{foo}}</td></tr>
      <tr><td>concat(ziz, foo):</td><td>{{concat(ziz, foo)}}</td></tr>
      <tr><td>compound ziz, concat:</td><td>{{ziz}} - {{concat(ziz, foo)}}</td></tr>
      <tr><td>bar (computed):</td><td>{{bar}}</td></tr>
      <tr><td>nard (computed below):</td><td>{{nard}}</td></tr>
    </table>
    <x-client foo="{{foo}}" ziz="{{ziz}}" bar="{{bar}}" nard="{{nard}}" nard2="{{nard}}"></x-client>
  </template>

  <template id="x-client">
    <style>
      :host {
        display: block;
        background: lightblue;
        padding: 8px;
        margin: 4px;
      }
    </style>
    <table>
      <tr><td>foo:</td><td><input value="{{foo::input}}"></td></tr>
      <tr><td>ziz:</td><td><input value="{{ziz::input}}"></td></tr>
      <tr><td>bar:</td><td><input value="{{bar}}" disabled></td></tr>
      <tr><td>nard (computed):</td><td><input value="{{nard}}" disabled></td></tr>
    </table>
  </template>

  <script>
  (function() {
    'use strict';

    var logEl = window.logEl = function(el) {
      return el.localName + (el.id ? '#' + el.id : '');
    };

    var template = document.querySelector('template#x-template');
    var attributes = new Polymer.AttributeToFromProperty();
    var events = new Polymer.GestureEventListeners();
    var stamper = new Polymer.TemplateStamp(events);
    var data = new Polymer.BatchedEffects(stamper, attributes);

    function registerXProperties(proto) {
      data.createReadOnlyProperty(proto, 'ziz', true);
      data.createReflectedProperty(proto, 'ziz');
      data.createObserver(proto, 'ziz', 'zizChanged');
      data.createObserver(proto, 'foo', 'fooChanged');
      data.addPropertyEffect(proto, 'foo', {
        fn: function() {
          console.log(logEl(this), 'custom', arguments);
        }
      });

      data.createNotifyingProperty(proto, 'foo');
      data.createComputedProperty(proto, 'bar', 'computeBar(foo, ziz)');
      data.createObserver(proto, 'bar', 'barChanged');
      data.createMultiObserver(proto, 'stuffChanged(foo, ziz)');
      data.createObserver(proto, 'nard','nardChanged');
      data.bindTemplate(proto, template);
      proto.__registered = true;
    }


    class XProperties extends HTMLElement {

      constructor() {
        this.createdCallback();
      }

      createdCallback() {
        data.prepare(this, function() {
          this.attachShadow({mode:'open'}).appendChild(data.stamp(this, template))
        });
        if (!this.__registered) {
          registerXProperties(this.__proto__);
        }
        if (this.hasAttribute('runtime')) {
          data.addPropertyEffect(this, 'foo', {
            fn: function() {
              console.log(logEl(this), 'custom2', arguments);
            }
          });
        }
        this.foo = 'foo';
        this._setZiz('ziz');      }

      attributeChangedCallback(name, old, value) {
        attributes.attributeToProperty(this, name, value);
      }

      connectedCallback() {
        this.attachedCallback();
      }

      attachedCallback() {
        data.flush(this);
      }

      zizChanged(value) {
        console.log(logEl(this), 'zizChanged', value);
      }

      fooChanged(value) {
        console.log(logEl(this), 'fooChanged', value);
      }

      computeBar(foo, ziz) {
        console.log(logEl(this), 'computeBar');
        return '[ ' + foo + ' - ' + ziz + ' ]';
      }

      barChanged(value) {
        console.log(logEl(this), 'barChanged', value);
      }

      stuffChanged(foo, ziz) {
        console.log(logEl(this), 'stuffChanged', foo, ziz);
      }

      concat(a, b) {
        return a + ' ' + b;
      }

      nardChanged(value) {
        console.log(logEl(this), 'nardChanged', value);
      }

    }

    customElements.define('x-properties', XProperties);

    // ---------------

    var clientTemplate = document.querySelector('template#x-client');

    function registerXClient(proto) {
      data.createNotifyingProperty(proto, 'foo');
      data.createNotifyingProperty(proto, 'ziz');
      data.createObserver(proto, 'ziz','zizChanged');
      data.createObserver(proto, 'foo','fooChanged');
      data.createObserver(proto, 'bar','barChanged');
      data.createMultiObserver(proto, 'stuffChanged(foo, ziz)');
      data.createComputedProperty(proto, 'nard', 'computeNard(bar)');
      data.createObserver(proto, 'nard','nardChanged');
      data.createObserver(proto, 'nard2','nard2Changed');
      data.createNotifyingProperty(proto, 'nard');
      data.bindTemplate(proto, clientTemplate);
    }

    class XClient extends HTMLElement {

      constructor() {
        this.createdCallback();
      }

      createdCallback() {
        data.prepare(this, function() {
          this.attachShadow({mode:'open'}).appendChild(data.stamp(this, clientTemplate))
        });
        if (!this.__registered) {
          registerXClient(this.__proto__);
        }
        this.foo = 'foo';
        this.ziz = 'ziz';
        this.bar = 'bar';      }

      attributeChangedCallback(name, old, value) {
        attributes.attributeToProperty(this, name, value);
      }

      connectedCallback() {
        this.attachedCallback();
      }

      attachedCallback() {
        data.flush(this);
      }

      zizChanged(value) {
        console.log(logEl(this), 'zizChanged', value);
      }

      fooChanged(value) {
        console.log(logEl(this), 'fooChanged', value);
      }

      stuffChanged(foo, ziz) {
        console.log(logEl(this), 'stuffChanged', foo, ziz);
      }

      barChanged(value) {
        console.log(logEl(this), 'barChanged', value);
      }

      computeNard(bar) {
        console.log(logEl(this), 'computeNard');
        return '<< ' + bar + ' >>';
      }

      nardChanged(value) {
        console.log(logEl(this), 'nardChanged', value);
      }

      nard2Changed(value) {
        console.log(logEl(this), 'nard2Changed', value);
      }

    }

    customElements.define('x-client', XClient);

    // ---------------

    class XPropertiesSub extends XProperties {

      createdCallback() {

        super.createdCallback();

        // data.addPropertyEffect(this, 'foo', {
        //   fn: function() {
        //     console.log(logEl(this), 'custom3', arguments);
        //   }
        // });

      }

      fooChanged2(value) {
        console.log(logEl(this), 'fooChanged2', value);
      }

    }

    data.createObserver(XPropertiesSub, 'foo',
      'fooChanged2');

    customElements.define('x-properties-sub', XPropertiesSub);

  })();
  </script>

  <x-properties id="el1" runtime foo="foo-thing"></x-properties>

  <x-client id="el2" foo="foo-attr"></x-client>

  <x-properties id="el2"></x-properties>

  <!-- <x-properties-sub id="el3" runtime></x-properties-sub> -->

   <script>

    var logEl = window.logEl;

    var el1 = document.getElementById('el1');
    el1.addEventListener('foo-changed', function(e) {
      console.log(logEl(this), 'notified:', e.type,  e.detail);
    });
    // console.log('// setProperties(el1, {foo: \'foo2\', ziz: \'ziz2\'}');
    // data.setProperties(el1, {
    //   foo: 'foo2',
    //   ziz: 'ziz2'
    // });

    // console.log('---');

    // var el2 = document.getElementById('el2');
    // console.log('// setProperties(el2, {foo: \'foo\', ziz: \'ziz\'}');
    // data.setProperties(el2, {
    //   foo: 'foo',
    //   ziz: 'ziz'
    // });

    // console.log('---');

    // var el3 = document.getElementById('el3');
    // console.log('// el3.foo = \'foo\';');
    // el3.foo = 'foo';
    // console.log('// el3._setZiz(\'ziz\');');
    // el3._setZiz('ziz');

  </script>

</body>
</html>
