<!doctype html>
<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>Polymer - setProperties</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../src/events/gesture-event-listeners.html">
  <link rel="import" href="../../src/template/template-stamp.html">
  <link rel="import" href="../../src/properties/batched-effects.html">
  <link rel="import" href="../../src/attributes/attribute-to-from-property.html">

</head>
<body>

  <template id="x-template">
    <style>
      :host {
        display: block;
        background: beige;
        padding: 8px;
        margin: 4px;
      }
      td:first-of-type {
        background: lightgray;
      }
    </style>
    <table>
      <tr><td foo$="{{foo}}" title="{{foo}}">foo:</td><td>{{foo}}</td></tr>
      <tr><td>concat(ziz, foo):</td><td>{{concat(ziz, foo)}}</td></tr>
      <tr><td>compound ziz, concat:</td><td>{{ziz}} - {{concat(ziz, foo)}}</td></tr>
      <tr><td>bar (computed):</td><td>{{bar}}</td></tr>
      <tr><td>nard (computed below):</td><td>{{nard}}</td></tr>
    </table>
    <x-client foo="{{foo}}" ziz="{{ziz}}" bar="{{bar}}" nard="{{nard}}" nard2="{{nard}}" nug="{{nug}}"></x-client>
  </template>

  <template id="x-client">
    <style>
      :host {
        display: block;
        background: lightblue;
        padding: 8px;
        margin: 4px;
      }
    </style>
    <table>
      <tr><td>foo:</td><td><input value="{{foo::input}}"></td></tr>
      <tr><td>ziz:</td><td><input value="{{ziz::input}}"></td></tr>
      <tr><td>bar:</td><td><input value="{{bar}}" disabled></td></tr>
      <tr><td>nard (computed):</td><td><input value="{{nard}}" disabled></td></tr>
    </table>
  </template>

  <script>
  (function() {
    'use strict';

    var logEl = window.logEl = function(el) {
      return el.localName + (el.id ? '#' + el.id : '');
    };

    var template = document.querySelector('template#x-template');
    var attributes = new Polymer.AttributeToFromProperty();
    var events = new Polymer.GestureEventListeners();
    var stamper = new Polymer.TemplateStamp(events);
    var data = new Polymer.BatchedEffects(stamper, attributes);

    class XHost extends HTMLElement {

      createdCallback() {
        this.foo = 'foo';
        this._setZiz('ziz');
        attributes.simulateV1AttributeCallbacks(this);
        data.setTemplate(this, template);
      }

      attributeChangedCallback(name, old, value) {
        attributes.attributeToProperty(this, name, value);
      }

      attachedCallback() {
        if (!this.shadowRoot) {
          var dom = data.ensureStamped(this);
          this.createShadowRoot().appendChild(dom);
        }
      }

      zizChanged(value) {
        console.log(logEl(this), 'zizChanged', value);
      }

      fooChanged(value) {
        console.log(logEl(this), 'fooChanged', value);
      }

      computeBar(foo, ziz) {
        console.log(logEl(this), 'computeBar');
        return '[ ' + foo + ' - ' + ziz + ' ]';
      }

      barChanged(value) {
        console.log(logEl(this), 'barChanged', value);
      }

      stuffChanged(foo, ziz) {
        console.log(logEl(this), 'stuffChanged', foo, ziz);
      }

      concat(a, b) {
        return a + ' ' + b;
      }

      nardChanged(value) {
        console.log(logEl(this), 'nardChanged', value);
      }

      nugChanged(value) {
        console.log(logEl(this), 'nugChanged', value);
      }

    }

    data.createReadOnlyProperty(XHost, 'ziz', true);
    data.createReflectedProperty(XHost, 'ziz');
    data.createObserver(XHost, 'ziz', 'zizChanged');
    data.createObserver(XHost, 'foo', 'fooChanged');
    data.addPropertyEffect(XHost, 'foo', {
      fn: function() {
        console.log(logEl(this), 'custom', arguments);
      }
    });

    data.createNotifyingProperty(XHost, 'foo');
    data.createComputedProperty(XHost, 'bar', 'computeBar(foo, ziz)');
    data.createObserver(XHost, 'bar', 'barChanged');
    data.createMultiObserver(XHost, 'stuffChanged(foo, ziz)');

    data.createObserver(XHost, 'nard','nardChanged');
    data.createObserver(XHost, 'nug', 'nugChanged');

    data.bindTemplate(XHost, template);

    document.registerElement('x-host', XHost);

    // ---------------

    var clientTemplate = document.querySelector('template#x-client');

    class XClient extends HTMLElement {

      createdCallback() {
        this.foo = 'foo';
        this.ziz = 'ziz';
        this.bar = 'bar';
        this.nug = 'nug';
        data.setTemplate(this, clientTemplate);
      }

      attributeChangedCallback(name, old, value) {
        attributes.attributeToProperty(this, name, value);
      }

      attachedCallback() {
        if (!this.shadowRoot) {
          var dom = data.ensureStamped(this);
          this.createShadowRoot().appendChild(dom);
        }
      }

      zizChanged(value) {
        console.log(logEl(this), 'zizChanged', value);
      }

      fooChanged(value) {
        console.log(logEl(this), 'fooChanged', value);
      }

      stuffChanged(foo, ziz) {
        console.log(logEl(this), 'stuffChanged', foo, ziz);
      }

      barChanged(value) {
        console.log(logEl(this), 'barChanged', value);
      }

      computeNard(bar) {
        console.log(logEl(this), 'computeNard');
        return '<< ' + bar + ' >>';
      }

      nardChanged(value) {
        console.log(logEl(this), 'nardChanged', value);
        this.nug = '*' + this.nug;
        console.log(logEl(this), 'new nug value:', this.nug);
      }

      nard2Changed(value) {
        console.log(logEl(this), 'nard2Changed', value);
      }

      nugChanged(value) {
        console.log(logEl(this), 'nugChanged', value);
      }

    }

    data.createNotifyingProperty(XClient, 'foo');
    data.createNotifyingProperty(XClient, 'ziz');
    data.createObserver(XClient, 'ziz','zizChanged');
    data.createObserver(XClient, 'foo','fooChanged');
    data.createObserver(XClient, 'bar','barChanged');
    data.createMultiObserver(XClient, 'stuffChanged(foo, ziz)');
    data.createComputedProperty(XClient, 'nard', 'computeNard(bar)');
    data.createObserver(XClient, 'nard','nardChanged');
    data.createObserver(XClient, 'nard2','nard2Changed');
    data.createNotifyingProperty(XClient, 'nard');
    data.createObserver(XClient, 'nug','nugChanged');
    data.createNotifyingProperty(XClient, 'nug');
    data.bindTemplate(XClient, clientTemplate);

    document.registerElement('x-client', XClient);

    class XHostSub extends XHost {

      createdCallback() {
        super.createdCallback();
        data.addPropertyEffect(this, 'foo', {
          fn: function() {
            console.log(logEl(this), 'custom3', arguments);
          }
        });
      }
      fooChanged2(value) {
        console.log(logEl(this), 'fooChanged2', value);
      }
    }
    data.createObserver(XHostSub, 'foo',
      'fooChanged2');
    document.registerElement('x-host-sub', XHostSub);

  })();
  </script>

  <x-host id="el1" runtime foo="foo-thing"></x-host>

  <hr>
<!--
  <x-client foo="foo-attr"></x-client>

  <hr>

  <x-host id="el2" foo="foo-thing"></x-host>

  <hr>

  <x-host-sub id="el3" runtime foo="foo-thing"></x-host-sub>
 -->
   <script>

    var logEl = window.logEl;

    var el1 = document.getElementById('el1');
    el1.addEventListener('foo-changed', function(e) {
      console.log(logEl(this), 'notified:', e.type,  e.detail);
    });
    // console.log('// setProperties(el1, {foo: \'foo2\', ziz: \'ziz2\'}');
    // data.setProperties(el1, {
    //   foo: 'foo2',
    //   ziz: 'ziz2'
    // });

    // console.log('---');

    // var el2 = document.getElementById('el2');
    // console.log('// setProperties(el2, {foo: \'foo\', ziz: \'ziz\'}');
    // data.setProperties(el2, {
    //   foo: 'foo',
    //   ziz: 'ziz'
    // });

    // console.log('---');

    // var el3 = document.getElementById('el3');
    // console.log('// el3.foo = \'foo\';');
    // el3.foo = 'foo';
    // console.log('// el3._setZiz(\'ziz\');');
    // el3._setZiz('ziz');

  </script>

</body>
</html>
