<!doctype html>
<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>Polymer - shady</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../src/shady/shady.html">
</head>
<body>

  <template id="v1">
    <div style="padding: 8px; background: #ccc;">
      <header>header (v1)</header>
      <div style="margin: 8px; padding: 8px; background: beige;">
        <div>A</div>
        <slot name="a"></slot>
      </div>
      <div style="margin: 8px; padding: 8px; background: beige;">
        <div>B</div>
        <slot name="b"></slot>
      </div>
      <footer>footer</footer>
    </div>
    <div id="last">last</div>
  </template>
  
  <script>
  HTMLImports.whenReady(function() {

    'use strict';

    var template = document.querySelector('template#v1');

    class XBaseV1 extends HTMLElement {
      
      attachedCallback() {
        if (!this.__stamped) {
          this.__stamped = true;
          this.attachShadow({mode: 'open'}).appendChild(
            document.importNode(template.content, true));
        }
        this._slotListener = function(e) {
          console.log(e.type, e.target, 'assignedNodes', e.target.assignedNodes());
        }
        this.shadowRoot.querySelector('slot').addEventListener('slotchange', 
          this._slotListener);
        var d = document.createElement('div');
        d.setAttribute('slot', 'b');
        d.textContent = 'dynamic';
        this.insertBefore(d, this.firstElementChild);
      }

    }

    document.registerElement('x-base-v1', XBaseV1);

  });

  </script>

  <x-base-v1 id="test">
    <div slot="a">light child</div>
  </x-base-v1>

  <script>
    
    function filterMutations(mxns, target) {
      return mxns.filter(function(mxn) {
        Polymer.ShadyDom.patch(mxn.target);
        var targetOk = (target.getRootNode() === mxn.target.getRootNode());
        if (targetOk) {
          if (mxn.addedNodes) {
            mxn.addedNodes = Array.from(mxn.addedNodes).filter(function(n) {
              Polymer.ShadyDom.patch(n);
              return target.getRootNode() === n.getRootNode();
            });
          }
        }
        return targetOk && (!mxn.addedNodes || mxn.addedNodes.length);
      });
    }

    // TODO(sorvell): limited MO wrapper with caveats:
    // * will not catch non-distributed children!
    // * cannot properly filter removedNodes (due to not being able to tell where they came from)
    function observe(callback, target, options) {
      Polymer.ShadyDom.patch(target);
      var observer = new MutationObserver(function(mxns) {
        mxns = filterMutations(mxns, target);
        if (mxns.length) {
          callback(mxns);
        }
      });
      observer.observe(target, options);
      return observer;
    }

    observe(function(mxns) {
      mxns.forEach(function(mxn) {
        console.log('observed add', mxn.addedNodes);
      })
    }, test, {childList: true, subtree: true})

    addEventListener('WebComponentsReady', function() {
      test.querySelector('[slot=a]').setAttribute('slot', 'b');
    });
  </script>

</body>
</html>
