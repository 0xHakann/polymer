<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <meta charset="utf-8">
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>
  <script>
    Polymer = function(prototype) {
      HTMLImports.whenReady(function() {
        Polymer(prototype);
      });
    };
  </script>
  <link rel="import" href="../../polymer.html">
<body>
<script>

  Polymer.BehaviorA = {

    properties: {

      label: {
        type: String,
        observer: '_labelChanged'
      },

      hasOptionsA: {
        readOnly: true,
        notify: true
      },

      overridableProperty: {
        value: false
      },

      overridablePropertyB: {
        value: false
      },

      hasBehaviorA: {
        value: true
      }
    },

    _simpleProperty: 'A',

    hostAttributes: {
      behavior: 'A',
      user: 'A'
    },

    listeners: {
      change: '_changeHandler'
    },

    ready: function() {
      this.__readyA = true;
    },

    _labelChanged: function(label) {
      this.__label = label;
    },

    _changeHandler: function(e) {
      this.__change = e.detail.value;
    },

    _toOverride: function() {
    }

  };

</script>

<script>

  Polymer.BehaviorB = {

    properties: {

      disabled: {
        type: Boolean,
        value: false,
        observer: '_disabledChanged'
      },

      hasOptionsB: {
        readOnly: true,
        notify: true
      },

      hasBehaviorB: {
        value: true
      },

      overridablePropertyB: {
        value: true
      }

    },

    hostAttributes: {
      behavior: 'B',
      user: 'B'
    },

    _simpleProperty: 'B',

    _disabledChanged: function(disabled) {
      this.__disabled = disabled;
    },

    ready: function() {
      this.__readyB = true;
    },

    _toOverride: function() {}

  };

</script>

<dom-module id="single-behavior">

  <script>

    Polymer({
      is: 'single-behavior',

      behaviors: [
        Polymer.BehaviorA
      ]

    });

  </script>

</dom-module>

<dom-module id="multi-behaviors">

  <script>

    Polymer({

      is: 'multi-behaviors',

      behaviors: [
        Polymer.BehaviorA,
        Polymer.BehaviorB
      ],

      properties: {

        foo: {
          type: String,
          reflectToAttribute: true,
          readOnly: true,
          observer: '_fooChanged'
        },

        overridableProperty: {
          value: true
        }

      },

      _fooChanged: function(foo) {
        this.__foo = foo;
      },

     _toOverride: Polymer._toOverride

    });

  </script>

</dom-module>

<script>

  Polymer.BehaviorC = {

    properties: {

      hasBehaviorC: {
        value: true
      }

    },

    _simpleProperty: 'C'

  };

  Polymer.BehaviorD = {

    properties: {

      hasBehaviorD: {
        value: true
      }

    },

    _simpleProperty: 'D'

  };

</script>

<dom-module id="nested-behaviors">

  <script>

    Polymer({

      is: 'nested-behaviors',

      behaviors: [
        [[Polymer.BehaviorC, Polymer.BehaviorB], Polymer.BehaviorA],
        Polymer.BehaviorD
      ]

    });

  </script>

</dom-module>

<!-- <dom-module id="behavior-as-is">

  <template><div id="content"></div></template>

</dom-module>

<script>

  Polymer.registerBehavior ={
    beforeRegister: function() {
      this.is = this.as;
      this.properties = {
        prop: {
          observer: 'propChanged1'
        }
      };
      this.hostAttributes = {
        attr: true
      };
      this.observers = [
        'propChanged2(prop)'
      ];
    },
    propChanged1: function() {
      this.propChanged1Called = true;
    },
    propChanged2: function() {
      this.propChanged2Called = true;
    }
  };

  try {

    Polymer({

      behaviors: [
        Polymer.registerBehavior
      ],

      as: 'behavior-as-is'

    });
  } catch(e) {
    window.behaviorAsIsFail = true;
  }

</script> -->

<dom-module id="behavior-registered">

  <template><div id="content"></div></template>

</dom-module>

<script>

  Polymer.registerBehavior ={
    registered: function() {
      this.constructor.createProperties({
        prop: {
          observer: 'propChanged1'
        }
      });
      this.constructor.createMethodObservers([
        'propChanged2(prop)'
      ]);
    },
    ready: function() {
      this.ensureAttributes({
        attr: true
      });
    },
    propChanged1: function() {
      this.propChanged1Called = true;
    },
    propChanged2: function() {
      this.propChanged2Called = true;
    }
  };

  Polymer({

    behaviors: [
      Polymer.registerBehavior
    ],

    is: 'behavior-registered'

  });

</script>


<script>

suite('single behavior element', function() {

  var el;

  setup(function() {
    el = document.createElement('single-behavior');
    document.body.appendChild(el);
    CustomElements.takeRecords();
  });

  teardown(function() {
    document.body.removeChild(el);
  });

  test('ready from behavior', function() {
    assert.equal(el.__readyA, true);
  });

  test('properties from behavior', function() {
    el.label = 'foo';
    assert.equal(el.__label, 'foo');
  });

  test('listener from behavior', function() {
    el.fire('change', {value: 'bar'});
    assert.equal(el.__change, 'bar');
  });

  test('property info from behavior A', function() {
    // BREAKME(sorvell): new api due to removal of `getPropertyInfo`
    assert.equal(el.constructor.data.hasNotifyEffect(el, 'hasOptionsA'), true);
    assert.equal(el.constructor.data.hasReadOnlyEffect(el, 'hasOptionsA'), true);
    assert.equal(typeof el._setHasOptionsA, 'function');
  });

  test.skip('beforeRegister behavior', function() {
    var el = document.createElement('behavior-as-is');
    document.body.appendChild(el);
    CustomElements.takeRecords();
    assert.equal(el.constructor.is, 'behavior-as-is');
    assert.ok(el.$.content);
    el.prop = 42;
    assert.isTrue(el.propChanged1Called);
    assert.isTrue(el.propChanged2Called);
    assert.isTrue(el.hasAttribute('attr'));
    document.body.removeChild(el);
  });

  test('registered behavior', function() {
    var el = document.createElement('behavior-registered');
    document.body.appendChild(el);
    CustomElements.takeRecords();
    assert.ok(el.$.content);
    el.prop = 42;
    assert.isTrue(el.propChanged1Called);
    assert.isTrue(el.propChanged2Called);
    assert.isTrue(el.hasAttribute('attr'));
    document.body.removeChild(el);
  });

});

suite('multi-behaviors element', function() {

  var el;

  setup(function() {
    var div = document.createElement('div');
    div.innerHTML = '<multi-behaviors user="user"></multi-behaviors>';
    el = div.firstElementChild;
    document.body.appendChild(el);
    CustomElements.takeRecords();
  });

  teardown(function() {
    document.body.removeChild(el);
  });

  test('ready from behaviors', function() {
    assert.equal(el.__readyA, true);
    assert.equal(el.__readyB, true);
  });

  test('properties from behaviors', function() {
    el.label = 'foo';
    assert.equal(el.__label, 'foo');
    el.disabled = true;
    assert.equal(el.__disabled, true);
  });

  test('properties from itself', function() {
    assert.isDefined(el._setFoo, 'readOnly setter not available');
    el._setFoo('bar');
    assert.equal(el.__foo, 'bar', 'observer not getting called');
    assert.equal(el.getAttribute('foo'), 'bar', 'not getting reflected');
  });

  test('listener from behaviors', function() {
    el.fire('change', {value: 'bar'});
    assert.equal(el.__change, 'bar');
  });

  test('property info from behavior A', function() {
    assert.equal(el.constructor.data.hasNotifyEffect(el, 'hasOptionsA'), true);
    assert.equal(el.constructor.data.hasReadOnlyEffect(el, 'hasOptionsA'), true);
    assert.equal(typeof el._setHasOptionsA, 'function');
  });

  test('property info from behavior B', function() {
    assert.equal(el.constructor.data.hasReadOnlyEffect(el, 'hasOptionsB'), true);
    assert.equal(el.constructor.data.hasNotifyEffect(el, 'hasOptionsB'), true);
    assert.equal(typeof el._setHasOptionsB, 'function');
  });

  test('multi-behavior overrides ordering', function() {
    assert.equal(el._toOverride, Polymer._toOverride, 'Behavior method was not overridden by prototype');
    assert(el.overridableProperty, 'Behavior property was not overridden by prototype');
    assert(el.overridablePropertyB, 'Behavior config-property was not overridden by sub-behavior');
  });

  test('hostAttributes ordering', function() {
    assert.equal(el.attributes.behavior.value, 'A', 'Behavior hostAttribute overridden by subclass');
    assert.equal(el.attributes.user.value, 'user', 'Behavior hostAttribute overrode user attribute');
  });

  test('behavior is null generates warning', function() {
    var warned = false, oldWarn = Polymer._warn;
    Polymer._warn = function(message) {
      assert.match(message, /behavior is null/);
      warned = true;
    };
    Polymer({
      is: 'behavior-null',
      behaviors: [
        null
      ]
    });
    document.createElement('behavior-null');
    assert.equal(warned, true, 'Null behaviour should generate warning');
    Polymer.Base._warn = oldWarn;
  });

  test('behavior array is unique', function() {
    Polymer({
      is: 'behavior-unique',
      behaviors: [Polymer.BehaviorA, Polymer.BehaviorA]
    });
    assert.equal(document.createElement('behavior-unique').behaviors.length, 1);
  });

  test('duplicate behaviors keep last behavior', function() {
    Polymer({
      is: 'behavior-unique-last-behavior',
      behaviors: [[Polymer.BehaviorA, Polymer.BehaviorB], Polymer.BehaviorA]
    });
    var behaviors = document.createElement('behavior-unique-last-behavior').behaviors;
    assert.deepEqual(behaviors, [Polymer.BehaviorB, Polymer.BehaviorA]);
  });

});


suite('nested-behaviors element', function() {

  var el;

  setup(function() {
    el = document.createElement('nested-behaviors');
    document.body.appendChild(el);
  });

  teardown(function() {
    document.body.removeChild(el);
  });

  test('nested-behavior overrides ordering', function() {
    assert.ok(el.hasBehaviorA, "missing BehaviorA");
    assert.ok(el.hasBehaviorB, "missing BehaviorB");
    assert.ok(el.hasBehaviorC, "missing BehaviorC");
    assert.ok(el.hasBehaviorD, "missing BehaviorD");
    assert.equal(el._simpleProperty, 'D', 'Behavior simple property was not overridden by sub-behavior');
  });

});

</script>

</body>
</html>
