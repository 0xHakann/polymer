<!doctype html>
<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <meta charset="utf-8">
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>
  <link rel="import" href="../../polymer.html">
  <!-- <link rel="import" href="../../src/features/more/shadow.html"> -->
  <link rel="import" href="projection-elements.html">
</head>
<body>

<x-test></x-test>

<script>

  suite('projection', function() {

    function getDestinationInsertionPoints(node) {
      return node._destinationInsertionPoints || 
        Array.prototype.slice.call(node.getDestinationInsertionPoints(), 0);
    }

    function getDistributedNodes(node) {
      return node._distributedNodes || 
        Array.prototype.slice.call(node.getDistributedNodes(), 0);
    }


    test('localDom.querySelector', function() {
      var test = document.querySelector('x-test');
      var projected = test.localDom.querySelector('#projected');
      assert.equal(projected.textContent, 'projected');
      var rere = test.localDom.querySelector('x-rereproject');
      assert.equal(rere.tag, 'x-rereproject');
      var re = rere.localDom.querySelector('x-reproject');
      assert.equal(re.tag, 'x-reproject');
      var p = re.localDom.querySelector('x-project');
      assert.equal(p.tag, 'x-project');
    });

    test('localDom.querySelectorAll', function() {
      var test = document.querySelector('x-test');
      var rere = test.localDom.querySelector('x-rereproject');
      var re = rere.localDom.querySelector('x-reproject');
      var p = re.localDom.querySelector('x-project');
      var rereList = rere.localDom.querySelectorAll('*');
      assert.include(rereList, re);
      assert.equal(rereList.length, 2);
      var reList = re.localDom.querySelectorAll('*');
      assert.include(reList, p);
      assert.equal(reList.length, 2);
      var pList = p.localDom.querySelectorAll('*');
      assert.equal(pList.length, 1);
    });

    test('lightDom.querySelector', function() {
      var test = document.querySelector('x-test');
      var projected = test.localDom.querySelector('#projected');
      var rere = test.localDom.querySelector('x-rereproject');
      var re = rere.localDom.querySelector('x-reproject');
      var p = re.localDom.querySelector('x-project');
      assert.equal(rere.lightDom.querySelector('#projected'), projected);
      assert(re.lightDom.querySelector('content'));
      assert(p.lightDom.querySelector('content'));
    });

    test('lightDom.querySelectorAll', function() {
      var test = document.querySelector('x-test');
      var projected = test.localDom.querySelector('#projected');
      var rere = test.localDom.querySelector('x-rereproject');
      var re = rere.localDom.querySelector('x-reproject');
      var p = re.localDom.querySelector('x-project');
      assert.equal(rere.lightDom.querySelectorAll('#projected')[0], projected);
      assert(re.lightDom.querySelectorAll('content').length, 1);
      assert(p.lightDom.querySelectorAll('content').length, 1);
    });

    test('querySelectorAllComposed', function() {
      var test = document.querySelector('x-test');
      var projected = test.localDom.querySelector('#projected');
      var rere = test.localDom.querySelector('x-rereproject');
      var re = rere.localDom.querySelector('x-reproject');
      var p = re.localDom.querySelector('x-project');
      assert.equal(rere.querySelectorAllComposed('#projected')[0], projected);
      assert.equal(re.querySelectorAllComposed('#projected')[0], projected);
      assert.equal(p.querySelectorAllComposed('#projected')[0], projected);
    });


    test('projection', function() {
      var test = document.querySelector('x-test');
      var projected = test.localDom.querySelector('#projected');
      assert.equal(projected.textContent, 'projected');
      var rere = test.localDom.querySelector('x-rereproject');
      assert.equal(rere.tag, 'x-rereproject');
      var re = rere.localDom.querySelector('x-reproject');
      assert.equal(re.tag, 'x-reproject');
      var p = re.localDom.querySelector('x-project');
      assert.equal(p.tag, 'x-project');
      var c1 = rere.localDom.querySelector('content');
      assert.include(getDistributedNodes(c1), projected);
      var c2 = re.localDom.querySelector('content');
      assert.include(getDistributedNodes(c2), projected);
      var c3 = p.localDom.querySelector('content');
      assert.include(getDistributedNodes(c3), projected);
      var ip$ = [c1, c2, c3];
      assert.deepEqual(getDestinationInsertionPoints(projected), ip$);
    });

    test('distributeContent', function() {
      var test = document.querySelector('x-test');
      test.distributeContent();
      var rere = test.localDom.querySelector('x-rereproject');
      assert.equal(rere.tag, 'x-rereproject');
      var re = rere.localDom.querySelector('x-reproject');
      assert.equal(re.tag, 'x-reproject');
      var p = re.localDom.querySelector('x-project');
      assert.equal(p.tag, 'x-project');
    });

    test('lightDom.appendChild', function() {
      var test = document.querySelector('x-test');
      var rere = test.localDom.querySelector('x-rereproject');
      var s = document.createElement('span');
      s.id = 'added';
      s.textContent = 'Added';
      rere.lightDom.appendChild(s);
      assert.equal(test.localDom.querySelector('#added'), s);
    });

    test('lightDom.insertBefore', function() {
      var test = document.querySelector('x-test');
      var rere = test.localDom.querySelector('x-rereproject');
      var ref = test.localDom.querySelector('#added');
      var s = document.createElement('span');
      s.id = 'added2';
      s.textContent = 'Added2';
      rere.lightDom.insertBefore(s, ref);
      assert.equal(test.localDom.querySelector('#added2'), s);
    });

    test('lightDom.removeChild', function() {
      var test = document.querySelector('x-test');
      var added = test.localDom.querySelector('#added');
      var added2 = test.localDom.querySelector('#added2');
      var rere = test.localDom.querySelector('x-rereproject');
      rere.lightDom.removeChild(added);
      rere.lightDom.removeChild(added2);
      assert.equal(test.localDom.querySelectorAll().length, 0);
    });

    test('localDom.appendChild', function() {
      var test = document.querySelector('x-test');
      var rere = test.localDom.querySelector('x-rereproject');
      var s = document.createElement('span');
      s.id = 'local';
      s.textContent = 'Local';
      rere.localDom.appendChild(s);
      assert.equal(rere.localDom.querySelector('#local'), s);
    });

    test('localDom.insertBefore', function() {
      var test = document.querySelector('x-test');
      var rere = test.localDom.querySelector('x-rereproject');
      var ref = test.localDom.querySelector('#local');
      var s = document.createElement('span');
      s.id = 'local2';
      s.textContent = 'Local2';
      rere.localDom.insertBefore(s, ref);
      assert.equal(rere.localDom.querySelector('#local2'), s);
    });

    test('localDom.removeChild', function() {
      var test = document.querySelector('x-test');
      var rere = test.localDom.querySelector('x-rereproject');
      var local = rere.localDom.querySelector('#local');
      var local2 = rere.localDom.querySelector('#local2');
      rere.localDom.removeChild(local);
      rere.localDom.removeChild(local2);
      assert.equal(rere.localDom.querySelectorAll('#local').length, 0);
    });

  });

</script>
</body>
</html>
