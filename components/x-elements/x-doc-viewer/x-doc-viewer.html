<!--
  @license
  Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
  This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
  The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
  The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
  Code distributed by Google as part of the polymer project is also
  subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../polymer/data.html">

<link rel="import" href="../../x-elements/x-drawer-panel.html">

<link rel="import" href="elements/context-free-parser.html">
<link rel="import" href="elements/x-doc-toc.html">
<link rel="import" href="elements/x-doc-page.html">


<!--
Displays formatted source documentation scraped from input urls.

Documentation can be encoded into html comments (&lt;!-- ... --&gt;) or using JsDoc notation (/&#42;&#42; ... &#42;/).

When using JsDoc notation, remember that the left-margin includes an asterisk and a single space.
This is important for markdown constructs that count spaces. Code blocks for example, must be
five spaces from the first asterisk.

## Markdown

Markdown format is supported.

### Links

Arbitrary links can be encoded using [standard markdown format](http://daringfireball.net/projects/markdown/syntax). 
[GitHub Flavored Markdown](https://help.github.com/articles/github-flavored-markdown) is also supported.

Links to other topics can be made with hash-links [core-doc-viewer](#core-doc-viewer).

### Code

Example

    Four space indents indicate code blocks.
    
    <code>blocks are syntax highlighted</code>
    
    <script>
      while(true) {
        javascript('is highlighted also');
      }
    </script>

### Blockquote

 > Blockquote is supported for long text that needs to wrap with a common left side indent.
 > Blockquote is supported for long text that needs to wrap with a common left side indent.  

### Lists
 
1.  enumerated
1.  lists
 
Use - or + for bullet points:
 
- bullet
- lists

### Tables

| First Header  | Second Header |
| ------------- | ------------- |
| Content Cell  | Content Cell  |
| Content Cell  | Content Cell  |

### HTML

Arbitrary HTML is also supported

<input><button>Button</button><hr/>

@class x-doc-viewer
@homepage github.io
-->

<style>

  x-doc-viewer x-doc-toc {
    width: 332px;
    overflow-x: hidden;
  }

</style>

<template>

  <context-free-parser url="{{url}}" on-data-ready="parserDataReady"></context-free-parser>

  <!--
  <template repeat="{{sources}}">
    <context-free-parser url="{{}}" on-data-ready="parserDataReady"></context-free-parser>
  </template>
  -->

  <x-doc-toc id="toc" data="{{classes}}" selected="{{selected}}"></x-doc-toc>

  <x-doc-page flex scroll data="{{data}}"></x-doc-page>

</template>

<script>

  Polymer({

    name: 'x-doc-viewer',

    published: {
      /**
       * A single file to parse for docs
       *
       * @attribute url
       * @type String
       * @default ''
       */
       //url: String,

      /**
       * Class documentation extracted from the parser
       *
       * @property classes
       * @type Array
       * @default []
       */
       classes: Array,

      /**
       * Files to parse for docs
       *
       * @attribute sources
       * @type Array
       * @default []
       */
       sources: Array
    },

    bind: {
      route: 'routeChanged',
      selected: 'selectedChanged'
    },

    hostAttributes: 'horizontal layout',

    created: function() {
      this.classes = [];
      this.selected = 0;
      addEventListener('hashchange', this.parseLocationHash.bind(this));
      this.parseLocationHash();
      this.nextSource();
    },

    nextSource: function() {
      var url = this.sources.shift();
      if (url) {
        this.url = url;
      }
    },

    parseLocationHash: function() {
      this.route = window.location.hash.slice(1);
    },

    routeChanged: function() {
      this.validateRoute();
    },

    validateRoute: function() {
      if (this.route) {
        // The URL fragment might be just a class name,
        // or it might be a class name followed by a '.' and then
        // a section of the page.
        // We want to match on class names here, so split on '.'.
        // E.g.: 'core-ajax.properties.xhrArgs' -> 'core-ajax'
        //       'core-xhr' -> 'core-xhr'
        var name = this.route.split('.')[0];
        this.classes.some(function(c) {
          if (c.name === name) {
            this.data = c;
            this.route = '';
            return true;
          }
        }, this);
      }
    },

    selectedChanged: function() { 
      this.data = this.classes[this.selected];
    },

    parserDataReady: function(e, detail, sender) {
      var path = this.parseDetailPath(''); //e.target.templateInstance.model);
      var data = e.target.data;
      this.fetchVersion(path, data, this.assimilateData.bind(this));
    },

    parseDetailPath: function(detailPath) {
      var path = '';
      if (this.sources && this.sources.length) {
        var path = detailPath;
        var idx = path.lastIndexOf('/');
        path = idx != -1 ? path.substr(0, idx) : '.';
      } else {
        var parts = location.pathname.split('/');
        parts.pop();
        path = parts.join('/');
      }
      return path;
    },

    fetchVersion: function(path, data, next) {
      var xhr = document.createElement('x-ajax');
      xhr.url = path + '/bower.json';
      xhr.handleResponse = function() {
        if (xhr.status == 200 && xhr.response) {
          try {
            var version = JSON.parse(xhr.response).version;
            // assumes all classes (elements) in the list are the same version
            for (var i = 0, c; c = data.classes[i]; ++i) {
              // add package version to data
              c.version = version;
            }
          } catch(x) {
            // bower.json no bueno
          }
        }
        next(data);
      };
      xhr.send();
    },

    assimilateData: function(data) {
      var classes = this.classes.concat(data.classes);
      classes.sort(function(a, b) {
        var na = a && a.name.toLowerCase(), nb = b && b.name.toLowerCase();
        return (na < nb) ? -1 : (na == nb) ? 0 : 1;
      });
      this.classes = classes;
      if (!this.data && !this.route && this.classes.length) {
        this.data = this.classes[0];
      }
      if (this.classes.length > 1) {
        this.$.toc.style.display = 'block';
      }
      this.validateRoute();
      this.nextSource();
    }

  });

</script>
