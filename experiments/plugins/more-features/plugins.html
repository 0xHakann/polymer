<script>
(function() {
  /**
    Experimental 'plugins' feature:

    Define a plugin:

    Polymer.plugins.stuffs = { ... api ... };

    Use a plugin:

    Polymer({
      name: 'x-foo',
      plugins: [
        'stuffs'
      ]
    });

    Plugin features:

    1. plugin api is mixed into element.
    TODO(sorvell): past here may be too much complexity. Need to evaluate
    2. polymer `magic` objects are sub-mixed-in, 'bind', 'listeners', 'published'
    3. puglins can use other plugins themselves.
    4. plugins can do initilization work by implementing `initPlugin`

    TODO(sorvell): Other potential features

    1. plugins can do registration time work.
    2. plugins avoid mixing in conflicting api. Instead, the idea would be that
    you can get a form of `super` via Polymer.plugins.stuffs.api.apply(this, arguments);

  */

  Base.addFeature({

    // TODO(sorvell): allow plugins registration access?
    register: function(prototype) {
      if (prototype.plugins) {
        prototype._plugins = collectPlugins(prototype.plugins);
        applyPlugins(prototype);
      }
    },

    // allow plugins to initialize themselves.
    init: function() {
      if (this._plugins) {
        this._plugins.forEach(function(p) {
          if (p.initPlugin) {
            p.initPlugin.call(this);
          }
        }, this);
      }
    }

  });

  function collectPlugins(plugins, list) {
    list = list || [];
    for (var i=plugins.length-1, p; (i>=0) && (p=plugins[i]); i--) {
      if (typeof p === 'string') {
        p = Polymer.plugins[p];
      }
      if (p) {
        if (p.plugins) {
          collectPlugins(p.plugins, list);
        }
        list.push(p);
      }
    }
    // store real plugins in reverse order for initilization
    return list;
  }

  function applyPlugins(prototype) {
    var plugins = prototype._plugins;
    for (var i=plugins.length-1, p; (i>=0) && (p=plugins[i]); i--) {
      plugin(prototype, p, features, excludes);
    }
  }

  // TODO(sorvell): ad hoc list; features could provide this
  // mixin feature objects
  var features = ['listeners', 'bind', 'published'];
  var excludes = ['initPlugin', 'plugins'];

  function plugin(prototype, api, mixinables, excludes) {
    mixinables = mixinables || [];
    excludes = excludes || [];
    if (prototype && api) {
      // use only own properties of 'api'
      Object.getOwnPropertyNames(api).forEach(function(n) {
        // support list of sub-objects
        if (mixinables.indexOf(n) >= 0) {
          if (!Object.getOwnPropertyDescriptor(prototype, n)) {
            prototype[n] = {};
          }
          plugin(prototype[n], api[n]);
        } else if (excludes.indexOf(n) < 0) {
          // acquire property descriptor
          var pd = Object.getOwnPropertyDescriptor(api, n);
          if (pd) {
            // clone property via descriptor
            Object.defineProperty(prototype, n, pd);
          }
        }
      });
    }
    return prototype;
  }

  Polymer.plugins = Polymer.plugins || {};
})();
</script>
