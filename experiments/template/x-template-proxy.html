<!--
  TODO(sorvell): we're using a proxy element to get Polymer api just until
  there's support for extending <template>.

  The helpers in XTemplate.fixTemplates() must currently be used in any element
  with an x-template in its template. It's called in `registerCallback`.

  This will probably need to be built into Polymer's feature system.

-->
<style>

  x-template-proxy {
    display: none;
  }

</style>
<script>

  Polymer({
    name: 'x-template-proxy'
  });
</script>

<script>

(function() {
 
  // make static proxy iff needed.
  var proxy;
  function getProxy() {
    if (!proxy) {
      proxy = document.createElement('x-template-proxy');
    }
    return proxy;
  }

  var refMap = {};

  // TODO(sorvell): helper to fix templates; will need to be integrated
  // into the feature system somehow.
  // workaround for https://code.google.com/p/chromium/issues/detail?id=430578.
  XTemplate = {

    fixTemplates: function(template) {
      if (template) {
        var $s = template.content.querySelectorAll('[is=x-template]');
        for (var i=0, l=$s.length, s; (i<l) && (s=$s[i]); i++) {
          if (!s.getAttribute('ref')) {
            var frag = document.createDocumentFragment();
            var content = s.content;
            while (content.firstChild) {
              frag.appendChild(content.firstChild);
            }
            var id = Math.floor(Math.random() * 1e12);
            this.addRef(id, frag);
            s.setAttribute('ref', id);
          }
        }
      }
    },

    addRef: function(id, dom) {
      var o = { content: dom };
      getProxy().parseAnnotations(o);
      refMap[id] = o;
    },

    refMap: refMap,

    getProxy: getProxy

  };

})();
</script>

