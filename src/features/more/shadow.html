<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script>
  
  using('Base', function(Base) {

    /**
      Implements `shadyRoot` compatible dom scoping using native ShadowDOM.
    */

    Base.addFeature({
	    poolContent: function() {
        this._useContent = this._useContent || Boolean(this._template);
        this.hasShadyRoot = this.hasShadowRoot = this._useContent;
	    },

	    // this should happen only 1x.
	    distributeContent: function() {
        // compose "clients"
        var c$ = this._getDistributionClients();
        for (var i=0, l= c$.length, c; (i<l) && (c=c$[i]); i++) {
          c.distributeContent();
        }
        // compose self
        if (this._useContent) {
          this._createShadowRoot();
        } else if (this.root !== this) {
          this.appendChild(this.root);
          this.root = this;
        }
      },

	    addLightChild: function(node, opt_index) {
	      if (opt_index === undefined) {
          this.appendChild(node);
        } else {
        	this.insertBefore(node, this.childNodes[opt_index]);
        }
	    },

	    removeLightChild: function(node) {
	    	node.parentNode.removeChild(node);
	    },

	    querySelectorLocal: function(selector) {
	      return this.root.querySelectorAll(selector);
	    },

	    queryLocal: function(matcher) {
	      var c$ = this.children;
	      var list = [];
	      for (var i=0, l=c$.length, c; (i<l) && (c=c$[i]); i++) {
          this._queryLocal(c, matcher, list);
	      }
	      return list;
	    },

	    _queryLocal: function(node, matcher, list) {
	      if (matcher(node)) {
	        list.push(node);
	      }
	      var c$ = node.children;
	      for (var i=0, l=c$.length, c; (i<l) && (c=c$[i]); i++) {
	         this._queryLocal(c, matcher, list);
	      }
	    },

 	    _createShadowRoot: function() {
	    	var root = this.createShadowRoot();
	      root.appendChild(this.root);
	      this.root = root;
	    }

  	});

	});

</script>
