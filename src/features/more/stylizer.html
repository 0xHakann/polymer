<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="style-transformer.html">
<script>

  using(['Base', 'Style-transformer', 'Css-parse'], function(Base, transformer, css) {
    
    var prepTemplate = Base._prepTemplate;
    var stampTemplate = Base._stampTemplate;

    var domModule = document.createElement('dom-module');

    // Transform styles if not using ShadowDOM or if flag is set.
    var useShadow = (window.PolymerSettings && PolymerSettings.shadow &&
      Element.prototype.createShadowRoot && !window.ShadowDOMPolyfill);

    Base.addFeature({

      // declaration-y
      _prepTemplate: function() {
        var port = domModule.import(this.is);
        this._encapsulateStyle = 
          !useShadow && (port && port.hasAttribute('encapsulate'));
        //console.log(this.is, this._encapsulateStyle);
        prepTemplate.call(this);
        if (this._encapsulateStyle) {
          if (this._template) {
            transformer.dom(this._template.content, this.is);
          }
          this._scopeCss();
        }
      },

      // TODO(sorvell): Need to decide where to place styles. If we do it
      // outside the template, HTMLImports will load them for us and fix paths;
      // however, ShadowDOM styles will not be properly parsed.
      _scopeCss: function() {
        var m = domModule.import(this.is);
        this._scopeStyles(m.querySelectorAll('style'));
        // TODO(sorvell): does not work in HTMLIMports polyfill since
        // SD rules are not parsed.
        //this._scopeStyles(m.querySelectorAll('link[rel=stylesheet]'));
      },

      _scopeStyles: function(styles) {
        // list of styles for later manipulation.
        this._styles = this._styles || [];
        for (var i=0, l=styles.length, s; (i<l) && (s=styles[i]); i++) {
          // NOTE: __appliedElement is supplied by the HTMLImports polyfill
          // and is the element in the main document used to apply styles.
          s = s.__appliedElement || s;
          // if (s.sheet) {
          //   // TODO(sorvell): Grabbing cssText does not work on browsers that
          //   // don't support SD rules since they are not parsed.
          //   var cssText = transformer.cssTextFromSheet(s.sheet);
          // }
          var cssText = s.textContent;
          s.parentNode.removeChild(s);
          this._styles.push(s);
          s.__cssRules = css.parse(cssText);
          transformer.applyCss(transformer.css(s.__cssRules, this.is), this.is);
        }
      },

      // instance-y

      _stampTemplate: function() {
        if (this._encapsulateStyle) {
          transformer.host(this, this.is);
        }
        stampTemplate.call(this);
      }

    });

  });
</script>
