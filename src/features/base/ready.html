<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script>

  /**
   *
   * Provides `ready` lifecycle callback which is called parent to child.
   *
   * This can be useful in a number of cases. Here are some examples:
   *
   * Setting a default property value that should have a side effect: To ensure
   * the side effect, an element must set a default value no sooner than
   * `created`; however, since `created` flows child to host, this is before the
   * host has had a chance to set a property value on the child. The `ready`
   * method solves this problem since it's called host to child.
   *
   * Dom distribution: To support reprojection efficiently, it's important to 
   * distribute from host to child in one shot. The `attachedCallback` mostly
   * goes in the desired order except for elements that are in dom to start; in
   * this case, all children are attached before the host element. Ready also
   * addresses this case since it's guaranteed to be called host to child.
   *
   * @class standard feature: ready
   */

  using('Base', function(Base) {

    // capture original method for calling from override
    var inheritedStampTemplate = Base.stampTemplate;

    var hostStack = [];

    Base.addFeature({

      // for overriding
      ready: function() {
      },

      queryHost: function() {
        return this.host;
      },

      stampTemplate: function() {
        // establishes this element as the current `host` 
        // so stamped elements can lookup host
        // TODO(sjmiles): ad-hoc dependency on 'ready' module
        this._prepareStamping();
        // call inherited method
        inheritedStampTemplate.call(this);
        // this element is no longer the current hosting element
        hostStack.pop();
        //
        // TODO(sjmiles): relocating _finishStamping to 
        // polymer-simplex init, needs review
        //
        // ensures dom is fully composed and attached to the element;
        // removes this element as the current `host`
        // after this, `this.root` points to the element itself.
        //this._finishStamping();
      },

      // 1. set this element's `host` and push this element onto the `host`'s
      // list of `client` elements
      // 2. establish this element as the current hosting element (allows 
      // any elements we stamp to easily set host to us).
      _prepareStamping: function() {
        this.host = hostStack[hostStack.length-1];
        if (this.host) {
          this.host._clients.push(this);
        }
        if (!this._clients) {
          this._clients = [];
        }
        hostStack.push(this);
      },

      // perform dom composition, if necessary
      _finishStamping: function() {
        //hostStack.pop();
        if (this._readied || !this.host || this.host._readied) {
          this.distributeContent();
        }
      },

      _checkReady: function() {
        if (!this.host || this.host._readied) {
          this._ready();
        }
      },

      // call `ready` if necessary ensuring host -> client ordering.
      _ready: function() {
        if (!this._readied) {
          // ready myself
          this._readied = true;
          this.ready();
          // ready my clients...
          var n$ = this._clients;
          for (var i=0, l=n$.length, n; (i<l) && (n=n$[i]); i++) {
            n._ready();
          }
          this._clients = null;
        }
      },

    });

  });

</script>
