<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="attribute-to-property.html">
<link rel="import" href="property-to-attribute.html">

<script>
(function() {

  'use strict';

  /**
   * Support for `hostAttributes` property.
   *
   *     hostAttributes: {
   *       'aria-role': 'button',
   *       tabindex: 0
   *     }
   *
   * `hostAttributes` is an object containing attribute names as keys and static values
   * to set to attributes when the element is created.
   *
   * Support for mapping attributes to properties.
   *
   * Properties that are configured in `properties` with a type are mapped
   * to attributes.
   *
   * A value set in an attribute is deserialized into the specified
   * data-type and stored into the matching property.
   *
   * Example:
   *
   *     properties: {
   *       // values set to index attribute are converted to Number and propagated
   *       // to index property
   *       index: Number,
   *       // values set to label attribute are propagated to index property
   *       label: String
   *     }
   *
   * Types supported for deserialization:
   *
   * - Number
   * - Boolean
   * - String
   * - Object (JSON)
   * - Array (JSON)
   * - Date
   *
   * This feature implements `attributeChanged` to support automatic
   * propagation of attribute values at run-time. If you override
   * `attributeChanged` be sure to call this base class method
   * if you also want the standard behavior.
   *
   * @class base feature: attributes
   */

  var CompatAttributes = Object.create(Polymer.PropertyToAttribute);
  Polymer.Utils.mixin(CompatAttributes, Polymer.AttributeToProperty);

  Polymer.Utils.mixin(CompatAttributes, {
    // for hostAttributes
    /* apply attributes to node but avoid overriding existing values */
    applyAttributes: function(node, attr$) {
      for (var attr in attr$) {
        // NOTE: never allow 'class' to be set in hostAttributes
        // since shimming classes would make it work
        // inconsisently under native SD
        if (!node.hasAttribute(attr) && (attr !== 'class')) {
          var value = attr$[attr];
          this.valueToAttribute(node, value, attr);
        }
      }
    }

  });


  CompatAttributes.Mixin = {

    hostAttributes: null,

    attributeChangedCallback: function(name, oldValue, newValue) {
      var property = Polymer.CaseMap.dashToCamelCase(name);
      var info = (this._propertyInfo && this._propertyInfo[property]);
      if (info && !info.readOnly) {
        CompatAttributes.attributeToProperty(this, info.attribute, property, 
          info.type);
      }
      this.attributeChanged(name, oldValue, newValue);
    },

    attributeChanged: function() {},

    serialize: function(value) {
      return CompatAttributes.serialize(value);
    },

    deserialize: function(value, type) {
      return CompatAttributes.deserialize(value, type);
    },

    reflectPropertyToAttribute: function(property, attribute, value) {
      CompatAttributes.propertyToAttribute(this, property, attribute, value);
    },

    serializeValueToAttribute: function(value, attribute, node) {
      CompatAttributes.valueToAttribute(this, value, attribute, value);
    }
    
  };

  // export
  Polymer.CompatAttributes = CompatAttributes;

})();
</script>
