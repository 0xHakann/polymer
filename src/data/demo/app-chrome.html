<!doctype html>
<html>
<head>

  <script src="../../../../perf-lib/perf.js"></script>

  <title>Bind Test</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="import" href="../bind.html">

  <style>
    pre {
      font-family: sans-serif;
      font-size: 14px;
    }
  </style>

</head>
<body>

  <script>console.perf();</script>

  <pre></pre>

  <script>
    var out = document.querySelector('pre');

    // phase one: prototyping

    var model = {};

    Bind.prepareModel(model);

    // 'method' effects are called if foo changes value as fx(foo, old)

    Bind.addPropertyEffect(model, 'foo', 'method', 'fooChange');
    Bind.addPropertyEffect(model, 'foo', 'method', 'fooWork');

    model.fooChange = function(foo) {
      out.innerHTML += '<b>fooChange</b>: effect of changing foo to ' + foo + '\n';
      console.log('fooChange: effect of changing foo to %d', foo);
    };

    model.fooWork = function(foo) {
      out.innerHTML += '<b>fooWork</b>: effect of changing foo to ' + foo + '\n';
      console.log('fooWork: effect of changing foo to %d', foo);
    };

    // 'method' effect sets the value of bar to the result of computeBar when
    // foo changes value

    Bind.addPropertyEffect(model, 'foo', 'compute', {
      method: 'computeBar',
      property: 'bar'
    });

    model.computeBar = function(foo) {
      var bar = foo * 2;
      out.innerHTML += '<b>computeBar</b>: bar set to ' + bar + ' as an effect of changing foo to ' + foo + '\n';
      console.log('computeBar: bar set to %d as effect of changing foo to %d', bar, foo);
    };

    // custom effect

    Bind._asyncEffectBuilder = function(model, property, effect) {
      var fn = function() {
        var flag = '_propertyTask';
        clearTimeout(this[flag]);
        this[flag] = setTimeout(function() {
          this.effect(this.property);
          this[flag] = 0;
        }.bind(this));
      };
      var code = fn.toString().split('\n').slice(1, -1).join('\n');
      return code.replace(/property/g, property).replace(/effect/g, effect);
    };

    Bind.addPropertyEffect(model, 'foo', 'async', 'asyncFoo');

    model.asyncFoo = function(foo) {
      out.innerHTML += '<b>asyncFoo</b>: effect of changing foo to ' + foo + '\n';
      console.log('asyncFoo: effect of changing foo to %d', foo);
    };

    // phase two: instancing

    Bind.prepareInstance(model);
    Bind.createBindings(model);

    model.foo = 3;
    model.foo = 6;

  </script>

  <script>console.perfEnd();</script>

</body>
</html>
