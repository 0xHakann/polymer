<!--
/*
 * Copyright 2012 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<element name="g-selector" attributes="selected" handlers="click: clickHandler">
  <link rel="components" href="g-component.html">
  <link rel="components" href="g-selection.html">
  <template>
    <content id="items"></content>
  </template>
  <script>
    this.component({
      created: function() {
        // use selection module
        var s = this.selection = document.createElement("g-selection");
        s.addEventListener("select", this._select.bind(this));
        s.addEventListener("deselect", this._deselect.bind(this));
        s.multi = this.hasAttribute('multi');
        // honor user input
        this.selectedAttributeChanged();
      },
      prototype: {
        getItems: function() {
          return this.$.items.distributedNodes;
        },
        _valueToIndex: function(inValue) {
          // find an item with value == inValue and return it's index
          var items = this.getItems();
          for (var i=0, c; c=items[i]; i++) {
            if (c.value && c.value == inValue) {
              return i;
            }
          }
          // if no item found, inSelected must be an index itself
          return inValue;
        },
        selectedAttributeChanged: function() {
          // remember that this.selected is an attribute-property,
          // it's for i/o, not for internal state tracking
          var index = this._valueToIndex(this.selected);
          var item = (this.getItems())[index];
          if (item != null) {
            this.selection.select(item);
          }
        },
        // events fired from <g-selection> object
        _select: function(inEvent) {
          inEvent.detail.item.classList.add('selected');
        },
        _deselect: function(inEvent) {
          inEvent.detail.item.classList.remove('selected');
        },
        // event fired from host
        clickHandler: function(evt) {
          var items = this.getItems();
          // find ancestor of target (including himself) that
          // is in our item list, if any
          var n = evt.target;
          while (n && n != this) {
            var i = items.indexOf(n);
            if (i != undefined) {
              // has side effects
              this.selected = n.value || i;
              break;
            }
            n = n.parentNode;
          }
        }
      }
    });
  </script>
</element>
