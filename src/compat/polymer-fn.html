<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script>

  (function() {

    // Polymer is a Function, but of course this is also an Object, so we
    // hang various other objects off of Polymer.*

    var userPolymer = window.Polymer;

    window.Polymer = function(prototype, mixin) {
      // if input is a `class` (aka a function with a prototype), use the prototype
      // remember that the `constructor` will never be called
      if (typeof prototype === 'function') {
        prototype = prototype.prototype;
      }
      // if there is no prototype, use a default empty object
      if (!prototype) {
        prototype = {};
      }
      // support mixin for properties on ES6 classes...
      if (mixin) {
        Polymer.Utils.extend(prototype, mixin);
      }

      // desugar the prototype and return a factory object
      prototype = desugar(prototype);
      var options = {
        prototype: prototype
      };
      // NOTE: we're specifically supporting older Chrome versions here
      // (specifically Chrome 39) that throw when options.extends is undefined.
      if (prototype.extends) {
        options.extends = prototype.extends;
      }
      Polymer.telemetry._registrate(prototype);
      document.registerElement(prototype.is, options);
      // TODO(sorvell): implement constructor.
      var PolymerConstructor = function(props) {
        return Polymer.Base.create(prototype.is, props);
      };
      PolymerConstructor.prototype = prototype;
      return PolymerConstructor;
    };

    var nativePrototypes = {};

    var getExtendedNativePrototype = function(tag) {
      var p = nativePrototypes[tag];
      if (!p) {
        var np = getNativePrototype(tag);
        p = Polymer.Utils.extend(Object.create(np), Polymer.Base);
        nativePrototypes[tag] = p;
      }
      return p;
    };

    /**
     * Returns the native element prototype for the tag specified.
     *
     * @method getNativePrototype
     * @param {string} tag  HTML tag name.
     * @return {Object} Native prototype for specified tag.
    */
    var getNativePrototype = function(tag) {
      return Object.getPrototypeOf(document.createElement(tag));
    }

    var desugar = function(prototype) {
      // Note: need to chain user prototype with the correct type-extended
      // version of Polymer.Base; this is especially important when you can't
      // prototype swizzle (e.g. IE10), since CustomElements uses getPrototypeOf
      if (!prototype.__isPolymerInstance__) {
        var base = Polymer.Base;
        if (prototype.extends) {
          base = getExtendedNativePrototype(prototype.extends);
        }
        prototype = Polymer.Base.chainObject(prototype, base);
      }
      return prototype;
    };

    if (userPolymer) {
      for (var i in userPolymer) {
        Polymer[i] = userPolymer[i];
      }
    }

    //Polymer.Class = desugar;

  })();

  /*
  // Raw usage
  [ctor =] Polymer.Class(prototype);
  document.registerElement(name, ctor);

  // Simplified usage
  [ctor = ] Polymer(prototype);
  */

  // telemetry: statistics, logging, and debug

  Polymer.telemetry = {
    registrations: [],
    _regLog: function(prototype) {
      console.log('[' + prototype.is + ']: registered')
    },
    _registrate: function(prototype) {
      this.registrations.push(prototype);
      Polymer.log && this._regLog(prototype);
    },
    dumpRegistrations: function() {
      this.registrations.forEach(this._regLog);
    }
  };

</script>
