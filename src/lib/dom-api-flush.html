<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script>

  // add Polymer.dom flush api...
  Polymer.Base.extend(Polymer.dom, {
    
    _flushGuard: 0,
    _FLUSH_MAX: 100,
    _needsTakeRecords: !Polymer.Settings.useNativeCustomElements,
    _debouncers: [],
    _finishDebouncer: null,

    // flush and debounce exposed as statics on Polymer.dom
    flush: function() {
      // flush debouncers
      for (var i=0; i < this._debouncers.length; i++) {
        this._debouncers[i].complete();
      }
      // clear the list of debouncers
      if (this._finishDebouncer) {
        this._finishDebouncer.complete();
      }
      // again make any pending CE mutations that might trigger debouncer
      // additions go...
      this._flushPolyfills();
      // flush again if there are now any debouncers to process
      if (this._debouncers.length && this._flushGuard < this._FLUSH_MAX) {
        this._flushGuard++;
        this.flush();
      } else {
        if (this._flushGuard >= this._FLUSH_MAX) {
          console.warn('Polymer.dom.flush aborted. Flush may not be complete.')
        }
        this._flushGuard = 0;
      }
    },

    // TODO(sorvell): There is currently not a good way 
    // to process all custom elements mutations under SD polyfill because
    // these mutations may be inside shadowRoots. 
    _flushPolyfills: function() {
      if (this._needsTakeRecords) {
        CustomElements.takeRecords();
      }
    },

    addDebouncer: function(debouncer) {
      this._debouncers.push(debouncer);
      // ensure the list of active debouncers is cleared when done.
      this._finishDebouncer = Polymer.Debounce(this._finishDebouncer, 
        this._finishFlush);
    },

    _finishFlush: function() {
      Polymer.dom._debouncers = [];
    }

  });

</script>