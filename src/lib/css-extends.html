<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="style-util.html">

<script>
Polymer.CssExtends = (function() {

  return {
    
    hasExtends: function(rules) {
      return Boolean(rules.cssText.match(this.rx.EXTEND));
    },

    transform: function(rules) {
      return Polymer.StyleUtil.toCssText(rules, function(rule) {
        var map = this._mapRule(rule);
        if (map) {
          var m;
          while (m = this.rx.EXTEND.exec(rule.cssText)) {
            var extend = m[1];
            var extendor = map[extend];
            if (extendor) {
              this._extendRule(rule, extendor);
            }
          }
        }
        rule.cssText = rule.cssText.replace(this.rx.EXTEND, '');
      }.bind(this));
    },

    _mapRule: function(rule) {
      if (rule.parent) {
        var map = rule.parent.map || (rule.parent.map = {});
        var parts = rule.selector.split(',');
        for (var i=0, p; i < parts.length; i++) {
          p = parts[i];
          map[p.trim()] = rule;
        }
        return map;
      }
    },

    _extendRule: function(target, source) {
      target.extends = target.extends || (target.extends = []);
      target.extends.push(source);
      source.selector = source.selector + ',\n' + target.selector;
      if (source.extends) {
        source.extends.forEach(function(e) {
          this._extendRule(target, e);
        }, this);
      }
    },

    rx: {
      EXTEND: /@extends\(([^)]*)\)\s*?;/gim
    }

  };

})();
</script>
