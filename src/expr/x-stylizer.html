<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="style-transformer.html">
<script>

  using(['Base', 'Style-transformer', 'Css-parse'], function(Base, transformer, css) {
    
    var beforeReady = Base._beforeReady;

    Base.addFeature({

      // called host before local children.
      _beforeConfigure: function() {
        this._computeStyleProperties();
        console.log(this.is, this._styleProperties);
      },

      _beforeReady: function() {
        beforeReady.call(this);
        if (this._styleProperties) {
          this.applyStyleProperties(this._styleProperties);
        }
      },

      _computeStyleProperties: function() {
        if (this.host) {
          this._styleProperties = this.host._computeElementStyleProperties(this);
        } else {
          this._styleProperties = Object.create(this.styleProperties || null);
          // apply values from defaults;
          this._stylePropertiesFromStyles(this, this._styleProperties, [defaultSheet]);
        }
        // TODO(sorvell): factor this to better spot.
        for (var i in this._styleProperties) {
          this._styleProperties[i] = 
            this._valueForProperty(this._styleProperties[i]);
        }
      },

      _computeElementStyleProperties: function(node) {
        var props = Object.create(this._styleProperties || null);
        if (node.styleProperties) {
          for (var i in node.styleProperties) {
            props[i] = node.styleProperties[i];
          }
        }
        this._stylePropertiesFromStyles(node, props, this._styles);
        return props;
      },

      _stylePropertiesFromStyles: function(node, props, styles) {
        var p = this._reifyCustomProperty.bind(this, props, node);
        if (styles) {
          for (var i=0, l=styles.length, s; (i<l) && (s=styles[i]); i++) {
            transformer.forEachStyleRule(s.__cssRules, p);
          }
        }
      },

      // test if a rule matches the given node and if so, 
      // collect any custom properties
      _reifyCustomProperty: function(properties, node, rule) {
        if (this.elementMatches(rule.selector, node)) {
          var m, p, v;
          // --g: var(--b); or --g: 5;
          while (m = CUSTOM_VAR_ASSIGN.exec(rule.cssText)) {
            p = m[1];
            v = m[2];
            properties[p] = this._valueForProperty(v);
          }
          // --g: { ... }
          // TODO(sorvell): support custom variable assignment within mixins
          while (m = CUSTOM_MIXIN_ASSIGN.exec(rule.cssText)) {
            p = m[1];
            v = m[2];
            properties[p] = v;
          }
        }
      },

      _valueForProperty: function(property) {
        var cv;
        while ((typeof property === 'string') && 
          (cv = property.match(CUSTOM_VAR_MATCH))) {
          property = this._styleProperties[cv[1]];
        }
        return property;
      },

      // declaration-y
      applyStyleProperties: function(bag) {
        var s$ = this._styles;
        if (s$) {
          this._ensureScopeSelector();
          var b = this._applyPropertiesToRule.bind(this, bag);
          var cssText = '';
          for (var i=0, l=s$.length, s; (i<l) && (s=s$[i]); i++) {
            cssText += transformer.css(s.textContent, this.is, b) + '\n\n';
          }
          if (cssText) {
            this._applyCustomCss(cssText);
          }
        }
      },

      _ensureScopeSelector: function() {
        if (!this._scopeSelector) {
          this._scopeSelector = this._scopeSelector || (this.is + 
            '-' + Math.floor(Math.random() * 1e6));
          this.classList.add(this._scopeSelector);
          this._scopeSelector = '.' + this._scopeSelector;
        }
      },

      _applyCustomCss: function(cssText) {
        if (this._customStyle) {
          this._customStyle.textContent = cssText;
        } else {
          this._customStyle = transformer.applyCss(cssText, this._scopeSelector);
        }
      },

      _applyPropertiesToRule: function(properties, rule) {
        this._scopifyRule(rule);
        if (rule.cssText.match(CUSTOM_RULE_RX)) {
          rule.cssText = this._applyPropertiesToText(rule.cssText, properties);
        } else {
          rule.cssText = '';
        }
        //console.log(rule.cssText);
      },

      _applyPropertiesToText: function(cssText, properties) {
        // TODO(sorvell): probably too simple; 
        // just remove @mixin(...) and var(...) for easy replacement
        cssText = cssText.replace(CUSTOM_RULE_TRIM, '$1;');
        for (var i in properties) {
          var p = properties[i], obj = typeof p === 'object';
          var r = obj ? this._mixinToCss(p) : 
            this._propertyToCss(p);
          cssText = cssText.replace(new RegExp(i + '[\\s;]', 'g'), r);
        }
        return cssText;
      },

      _mixinToCss: function(mixin) {
        var s = [];
        for (var i in mixin) {
          s.push(i + ': ' + mixin[i] + ';');
        }
        return s.join('\n') + '\n';
      },

      _propertyToCss: function(property) {
        var p = property.trim();
        p = p[p.length-1] === ';' ? p : p + ';';
        return p + '\n';
      },

      _scopifyRule: function(rule) {
        var selector = rule.selector;
        var host = this.is + HOST_SCOPE_SUFFIX;
        var parts = selector.split(',');
        for (var i=0, l=parts.length, p; (i<l) && (p=parts[i]); i++) {
          parts[i] = (p.indexOf(host) >= 0) ?
            p.replace(host, host + this._scopeSelector) :
            this._scopeSelector + ' ' + p;
        }
        rule.selector = parts.join(',');
      },

      updateStyles: function() {
        this._computeStyleProperties();
        this.applyStyleProperties(this._styleProperties);
        var c$ = this._getDistributionClients();
        for (var i=0, l= c$.length, c; (i<l) && (c=c$[i]); i++) {
          c.updateStyles();
        }
      },

      addStyleDefaults: function(defaults) {
        addStyleDefaults(defaults);
      }

    });

    var defaultSheet = document.createElement('style'); 

    function addStyleDefaults(defaults) {
      defaultSheet.textContent += defaults;
      defaultSheet.__cssRules = css.parse(defaultSheet.textContent);
    }
    addStyleDefaults('');


    var HOST_SCOPE_SUFFIX = '-xx';
    var CUSTOM_MIXIN = '@mixin';
    var CUSTOM_VAR = 'var';
    var CUSTOM_RULE_RX = /@mixin|var/;
    var CUSTOM_RULE_TRIM = /(?:@mixin|var)\(([^)]*)\);/gim;
    var CUSTOM_VAR_ASSIGN = /(--[^\:;]*?):\s*?([^;{]*?);/g;
    var CUSTOM_VAR_MATCH = /^var\(([^)]*?)\)/;
    var CUSTOM_MIXIN_ASSIGN = /(--[^\:;]*?):[^{;]*?{([^}]*?)}/g;

  });
</script>
