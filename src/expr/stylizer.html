<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../lib/style-util.html">
<link rel="import" href="style-transformer.html">
<link rel="import" href="shadow-settings.html">
<script>

  using(['Base', 'StyleTransformer', 'StyleUtil', 'ShadowSettings'], 
    function(Base, transformer, styleUtil, settings) {
    
    var prepTemplate = Base._prepTemplate;
    var stampTemplate = Base._stampTemplate;

    var domModule = document.createElement('dom-module');

    Base.addFeature({

      // declaration-y
      _prepTemplate: function() {
        prepTemplate.call(this);
        var port = domModule.import(this.is);
        this._encapsulateStyle = (port && port.hasAttribute('encapsulate')) &&
          !settings.useNativeShadow;
        if (this._encapsulateStyle) {
          if (this._template) {
            transformer.dom(this._template.content, this.is);
          }
        }
        if (settings.useNativeShadow || this._encapsulateStyle) {
          this._scopeCss();
        }
      },

      // TODO(sorvell): Need to decide where to place styles. If we do it
      // outside the template, HTMLImports will load them for us and fix paths;
      // however, ShadowDOM styles will not be properly parsed.
      _scopeCss: function() {
        var m = domModule.import(this.is);
        if (m) {
          this._scopeStyles(m.querySelectorAll('style'));
        }
      },

      _scopeStyles: function(styles) {
        // list of styles for later manipulation.
        this._styles = this._styles || [];
        for (var i=0, l=styles.length, s; (i<l) && (s=styles[i]); i++) {
          // NOTE: __appliedElement is supplied by the HTMLImports polyfill
          // and is the element in the main document used to apply styles.
          s = s.__appliedElement || s;
          var cssText = s.textContent;
          s.parentNode.removeChild(s);
          this._styles.push(s);
          s.__cssRules = styleUtil.parser.parse(cssText);
          if (settings.useNativeShadow) {
            this._template.content.appendChild(s);
          } else {
            styleUtil.applyCss(transformer.css(s.__cssRules, this.is), this.is);
          }
        }
      },

      // instance-y
      _stampTemplate: function() {
        if (this._encapsulateStyle) {
          transformer.host(this, this.is);
        }
        stampTemplate.call(this);
      }

    });

  });
</script>
