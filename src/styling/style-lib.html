<!doctype html>
<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../utils/boot.html">
<link rel="import" href="../utils/utils.html">
<link rel="import" href="style-transformer.html">
<link rel="import" href="style-util.html">
<link rel="import" href="style-properties.html">
<link rel="import" href="apply-shim.html">
<script>
(function() {
  'use strict';

  class StyleLib {
    constructor(nativeShadow, nativeCss) {
      this.nativeShadow = nativeShadow;
      this.nativeCss = nativeCss;
      this.scopeCounter = {};
    }
    _generateScopeSelector(name) {
      var id = this.scopeCounter[name] = (this.scopeCounter[name] || 0) + 1;
      return name + '-' + id;
    }
    _prepareTemplate(template, tagname) {
      var cssText = '';
      var styles = template.content.querySelectorAll('style');
      for (var i = 0; i < styles.length; i++) {
        var s = styles[i];
        cssText += s.textContent;
        s.parentNode.removeChild(s);
      }
      if (!this.nativeShadow) {
        template._placeholder = Polymer.StyleUtil.applyStylePlaceHolder(tagname);
        Polymer.StyleTransformer.dom(template.content, tagname);
      }
      var ast = Polymer.CssParse.parse(cssText);
      if (this.nativeCss) {
        Polymer.StyleUtil.forEachRule(ast, function(rule) {
          Polymer.ApplyShim.transformRule(rule);
        });
      }
      template._styleAst = ast;
    }
    prepareHost(host, template) {
      if (!template._prepared) {
        this._prepareTemplate(template, host.localName);
        var ownPropertyNames = [];
        if (!this.nativeCss) {
          ownPropertyNames = Polymer.StyleProperties.decorateStyles([{__cssRules: template._styleAst}], host, this.nativeShadow);
        }
        if (!ownPropertyNames.length) {
          var cssText = Polymer.StyleTransformer.elementStyles(host, {__cssRules: template._styleAst}, this.nativeShadow);
          if (cssText.length) {
            Polymer.StyleUtil.applyCss(cssText, host.localName, this.nativeShadow ? template.content : null, template._placeholder)
          }
        }
        template._ownPropertyNames = ownPropertyNames;
        template._prepared = true;
      }
      var style = document.createElement('style');
      style.__cssRules = template._styleAst;
      host.__style = style;
      host.__placeholder = template._placeholder;
      if (!this.nativeCss) {
        host.__styleProperties = null;
        host.__ownStyleProperties = null;
        host.__scopeSelector = null;
        host.__ownStylePropertyNames = template._ownPropertyNames;
      }
    }
    applyStyle(host, overrideProps) {
      if (this.nativeCss) {
        Polymer.StyleProperties.updateNativeStyleProperties(host, overrideProps);
      } else {
        this._updateProperties(host, overrideProps);
        if (host.__ownStylePropertyNames.length) {
          // TODO: use caching
          this._applyStyleProperties(host);
        }
        this._applyToDescendants(host);
      }
    }
    _applyToDescendants(host) {
      var root = host.shadowRoot;
      for (var i = 0, c; i < root.children.length; i++) {
        c = root.children[i];
        if (c.__style) {
          this.applyStyle(c);
        }
      }
    }
    _applyStyleProperties(host) {
      var style = host.__style;
      var oldScopeSelector = host.__scopeSelector;
      host.__scopeSelector = this._generateScopeSelector(host.localName);
      style = Polymer.StyleProperties.applyElementStyle(host, host.__styleProperties, host.__scopeSelector, null, this.nativeShadow);
      if (!this.nativeShadow) {
        Polymer.StyleProperties.applyElementScopeSelector(host, host.__scopeSelector, oldScopeSelector);
      }
      return style;
    }
    _updateProperties(host, overrideProps) {
      var ownerRoot = Polymer.Utils.ownerRootForNode(host);
      var owner = ownerRoot && ownerRoot.host || document;
      var ownerProperties = owner.__styleProperties;
      var props = Object.create(ownerProperties || null);
      var hostAndRootProps = Polymer.StyleProperties.hostAndRootPropertiesForScope(host, [host.__style], this.nativeShadow);
      Object.assign(props, hostAndRootProps.hostProps);
      var propertiesMatchingHost = Polymer.StyleProperties.propertyDataFromStyles([owner.__style], host).properties;
      Object.assign(props, propertiesMatchingHost);
      Object.assign(props, hostAndRootProps.rootProps);
      Object.assign(props, overrideProps);
      Polymer.StyleProperties.reify(props);
      host.__styleProperties = props;
      var ownProps = {};
      for (var i = 0, n; i < host.__ownStylePropertyNames.length; i++) {
        n = host.__ownStylePropertyNames[i];
        ownProps[n] = props[n];
      }
      host.__ownStyleProperties = ownProps;
    }
  }

  var nativeShadow = !Boolean(Polymer.ShadyDom);
  // chrome 49 has semi-working css vars, check if box-shadow works
  // safari 9.1 has a recalc bug: https://bugs.webkit.org/show_bug.cgi?id=155782
  var nativeCss = (!navigator.userAgent.match('AppleWebKit/601') && window.CSS
          && CSS.supports && CSS.supports('box-shadow', '0 0 0 var(--foo)'));

  Polymer.StyleLib = new StyleLib(nativeShadow, nativeCss);
  Polymer.StyleUtil.NATIVE_VARIABLES = nativeCss;
})();
</script>
