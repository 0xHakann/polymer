<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<script>
(function() {

  'use strict';
  var PropertyAccessors = {

    createAccessor: function(model, property, readOnly) {
      model = this.getModel(model);
      this._ensureEffects(model, '_propertyEffects');
      var effects = model._propertyEffects[property];
      if (!effects) {
        effects = model._propertyEffects[property] = [];
        this._createAccessor(model, property, readOnly);
      }
      return effects;
    },

    addPropertyEffect: function(model, property, effect) {
      this.createAccessor(model, property).push(effect);
    },

    getModel: function(model) {
      return typeof model == 'function' ? model.prototype : model;
    },

    _ensureEffects: function(model, name) {
      var effects = model[name];
      if (!effects) {
        effects = model[name] = {};
      } else if (!model.hasOwnProperty(name)) {
        effects = model[name] = Object.create(model[name]);
        for (var p in effects) {
          // TODO(kschaaf): replace with fast array copy #!%&$!
          effects[p] = effects[p].slice();
        }
      }
      return effects;
    },

    _createAccessor: function(model, property, readOnly) {
      var self = this;
      var defun = {
        get: function() {
          // TODO(sjmiles): elide delegation for performance, good ROI?
          return this.__data__ && this.__data__[property];
        }
      };
      var setter = function(value) {
        self._propertySetter(this, property, value);
      };
      if (readOnly) {
        model['_set' + this._upper(property)] = setter;
      } else {
        defun.set = setter;
      }
      Object.defineProperty(model, property, defun);
    },

    _upper: function(name) {
      return name[0].toUpperCase() + name.substring(1);
    },

    _propertySetter: function(inst, property, value) {
      if (!inst.__data__) {
        inst.__data__ = {};
      }
      var old = inst.__data__[property];
      if (this.isPropertyDirty(value, old)) {
        inst.__data__[property] = value;
        var effects = inst._propertyEffects[property];
        if (effects) {
          this._runEffects(inst, property, value, old, effects);
        }
      }
      return old;
    },

    _runEffects: function(inst, property, value, old, effects) {
      for (var i=0, l=effects.length, fx; (i<l) && (fx=effects[i]); i++) {
        fx.fn.call(inst, property, value, old, fx.info);
      }
    },

    isPropertyDirty: function(value, old) {
      return ((old !== value && (old === old || value === value)) ||
        (typeof value == 'object'));
    }

  };

  // export
  Polymer.PropertyAccessors = PropertyAccessors;

})();
</script>
