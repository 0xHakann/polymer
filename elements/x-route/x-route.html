<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../polymer/data.html">

<script>

  (function() {

    var route;

    var requireRouting = function() {
      addEventListener('popstate', popStateHandler);
      requireRouting = function() {};
      parseLocation();
    };

    var popStateHandler = function() {
      parseLocation();
      Base.fire('route-change', route, window, false);
    };

    var parseLocation = function() {
      route = location.hash.slice(1);
    };

    var getRoute = function() {
      return route;
    };

    var setRoute = function(value) {
      if (value !== route) {
        route = value;
        history.replaceState(null, '', '#' + route);
        popStateHandler();
      }
    };

    Polymer({

      name: 'x-route',

      published: {
        peek: Boolean,
        match: {
          type: String,
          notify: true
        }
      },

      created: function() {
        requireRouting();
        // must memoize this method for removeListener
        this.retrieveRoute = this.retrieveRoute.bind(this);
      },

      attached: function() {
        addEventListener('route-change', this.retrieveRoute);
        //this.retrieveRoute();
      },

      dettached: function() {
        removeEventListener('route-change', this.retrieveRoute);
      },

      locateAncestorRouter: function() {
        var ancestor, n = this.parentNode;
        // find ancestor node that contains an x-route
        while (!ancestor && n) {
          n = n.parentNode;
          if (n) {
            ancestor = n.querySelector(':scope > x-route');
            if (ancestor == this) {
              ancestor = null;
            }
          }
        }
        // return whatever we found
        return ancestor;
      },

      retrieveRoute: function() {
        //console.log('[%s.retrieveRoute]', this.localName + (this.id ? '#' + this.id : ''));
        var ancestor = this.locateAncestorRouter();
        if (!ancestor|| ancestor.active) {
          this.parseRoute(ancestor ? (ancestor.subroute || '') : getRoute());
        }
      },

      locateRequiredRoute: function() {
        // find ancestor node that contains an `route` attribute
        var n = this.parentNode;
        while (n && n.getAttribute) {
          var route = n.getAttribute('route');
          if (route) {
            return route;
          }
          n = n.parentNode;
        }
        return '';
      },

      parseRoute: function(route) {
        var routes = route.split('/');
        var segment = routes[0] || '';
        var route = this.locateRequiredRoute();
        if (route) {
          if (route !== segment) {
            return;
          }
          routes.shift();
          segment = routes[0] || '';
        }
        this.active = true;
        this.match = segment;
        if (!this.peek) {
          routes.shift();
        }
        this.subroute = routes.join('/');
        console.log('[parseRoute]: [%s]: [%s] [%s]/[%s]', this.localName + (this.id ? '#' + this.id : ''), route, this.match, this.subroute);
      },

      setRoute: function(route) {
        var ancestor = this.locateAncestorRoute();
        if (ancestor) {
          ancestor.setSubRoute(route);
        } else {
          setRoute(route);
        }
      },

      setSubRoute: function(route) {
        this.setRoute(this.route + '/' + route);
      }

    });

  })();

</script>
