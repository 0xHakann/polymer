<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../polymer/data.html">

<link rel="import" href="../../../elements/x-icon.html">
<link rel="import" href="../../../elements/x-repeater.html">
<link rel="import" href="../../../elements/x-selector.html">
<link rel="import" href="../../../elements/x-pages.html">
<link rel="import" href="../../../elements/x-drawer-panel2.html">

<link rel="import" href="google-apis/google-feeds.html">

<link rel="import" href="pi-topic-item.html">
<link rel="import" href="pi-item.html">

<link rel="stylesheet" href="pi-app.css">

<template>

  <x-drawer-panel2 id="drawerPanel" flex>
  
    <div drawer vertical layout>

      <div flex none header>
        <div horizontal layout>
          <span flex>Pica</span>
        </div>
      </div>
  
      <div flex scroll vertical layout menu on-click="closeDrawerAction">
        <item on-click="topicsAction"><x-icon icon="apps"></x-icon>Topics</item>
        <item><x-icon icon="explore"></x-icon>Explore</item>
        <item><x-icon icon="account-box"></x-icon>Accounts</item>
      </div>
  
    </div>
  
    <x-pages main flex vertical layout selected="{{page}}">
  
      <div id="main" flex vertical layout>
        <div flex none header horizontal layout>
          <x-icon icon="menu" x-drawer-toggle></x-icon>
          <span flex>Topics</span>
          <x-icon icon="refresh"></x-icon>
          <x-icon icon="more-vert"></x-icon>
        </div>
        <div flex scroll>
          <x-selector id="topicsSelector" selectable="pi-topic-item" on-click="topicAction">
            <x-repeater id="topics" horizontal center-justified wrap layout kind="pi-topic-item" items="{{topics}}"></x-repeater>
          </x-selector>
        </div>
      </div>
  
      <div id="topic" flex vertical layout>
        <div flex none header horizontal layout>
          <x-icon icon="back" on-click="topicsAction"></x-icon>
          <span flex>{{topicName}}</span>
          <x-icon icon="apps" on-click="toggleLayoutAction"></x-icon>
          <x-icon icon="refresh"></x-icon>
          <x-icon icon="more-vert"></x-icon>
        </div>
        <div flex scroll vertical layout>
          <x-selector id="articlesSelector" selectable="pi-item" on-click="articleAction">
            <x-repeater id="articles" kind="pi-item" items="{{items}}"></x-repeater>
          </x-selector>
        </div>
      </div>
  
      <div id="article" flex vertical center layout>
        <div flex none self-stretch header horizontal layout>
          <x-icon icon="back" on-click="topicAction"></x-icon>
          <span flex>{{topicName}}</span>
          <x-icon icon="refresh"></x-icon>
          <x-icon icon="more-vert"></x-icon>
        </div>
        <div class="main-outer" flex scroll>
          <div id="articleMain">
            <div class="title">{{articleTitle}}</div>
            <div class="info">{{articleInfo}}</div>
            <div id="content"></div>
          </div>
        </div>
      </div>
  
    </x-pages>

  </x-drawer-panel2>

</template>

<script>

(function() {
  
  Polymer({
    name: 'pi-app',
    hostAttributes: 'horizontal layout',
    bind: {
      quilt: 'quiltChanged'
    },
    created: function() {
      this.topics = topics;
      this.quilt = false;
    },
    closeDrawerAction: function() {
      this.$.drawerPanel.closeDrawer();
    },
    topicsAction: function() {
      this.page = 0;
      this.animatize(this.$.topics);
    },
    topicAction: function(e) {
      var t = this.$.topicsSelector.selected.item;
      this.items = t.items;
      this.topicName = t.topic;
      this.page = 1;
      this.animatize(this.$.articles);
    },
    articleAction: function() {
      var a = this.$.articlesSelector.selected.item;
      this.articleTitle = a.title;
      this.articleInfo = 'by ' + a.author + ' on ' + a.publishedDate;
      var content = a.content;
      if (content) {
        this.$.content.innerHTML = 
          content.replace(/(<iframe.*?>.*?<\/iframe>)/g, '');
      }
      this.page = 2;
      this.animatize(this.$.articleMain);
    },
    toggleLayoutAction: function() {
      this.quilt = !this.quilt;
      this.topicAction();
    },
    quiltChanged: function() {
      this.$.topic.classList.toggle('quilt', this.quilt);
    },
    animatize: function(container) {
      var a$ = container;
      a$.className = '';
      for (var i=0, c=a$.firstElementChild; c; c=c.nextElementSibling, i++) {
        c.style.transform = c.style.webkitTransform =
            'translate3d(0,' + (Math.pow(i, 2.2)*3 + 50) + 'px,0)';
      }
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          a$.className = 'animate';
          for (var c=a$.firstElementChild; c; c=c.nextElementSibling) {
            c.style.transform = c.style.webkitTransform = 'translate3d(0,0,0)';
          }
        });
      });
    }
  });

  var topics = [
    {topic: 'Technology', feed: 'http://www.theverge.com/rss/index.xml'},
    {topic: 'Sports', feed: 'http://feeds.gawker.com/deadspin/full'},
    {topic: 'Music', feed: 'http://feeds.feedburner.com/indieshuffle'},
    {topic: 'Art', feed: 'http://feeds.feedburner.com/wooster'},
    {topic: 'Fashion', feed: 'http://feeds.feedburner.com/hypebeast/feed'},
    {topic: 'Architecture', feed: 'http://feeds.feedburner.com/dezeen'},
    {topic: 'Design', feed: 'http://feeds.feedburner.com/design-milk'},
    {topic: 'Food', feed: 'http://feeds.thekitchn.com/apartmenttherapy/thekitchn'}
  ];
  
})();

</script>
