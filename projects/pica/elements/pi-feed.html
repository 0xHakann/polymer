<script>

Polymer({
  name: 'pi-feed',
  bind: {
    topic: 'topicChanged'
  },
  topicChanged: function() {
    if (this.topic) {
      this.populateFeed(this.topic);
    }
  },
  populateFeed: function(topic) {
    var googleFeeds = document.createElement('google-feeds');
    googleFeeds.addEventListener('google-feeds-response', function(e) {
      var items = e.detail.feed && e.detail.feed.entries || [];
      topic.items = items;
      items.forEach(function(item) {
        var m$ = item.content.match(/<img[^>]+src="([^">]+)"/);
        item.thumb = m$ && m$[1];
        item.blurb = item.contentSnippet;
      });
      this.fire('feed-load');
      this.findTopicThumbnail();
    }.bind(this));
    googleFeeds.feed = topic.feed;
  },
  findTopicThumbnail: function(index) {
    index = index || 0;
    var item = this.topic.items[index];
    if (!this.topic.thumb && item) {
      var image = new Image();
      image.src = item.thumb;
      image.onload = this.thumbnailLoaded.bind(this, index);
    }
  },
  thumbnailLoaded: function(index, e) {
    var img = e.currentTarget;
    // use the image if the size > 10 x 10px
    if (img.width > 10 && img.height > 10) {
      this.topic.thumb = img.src;
      this.fire('topic-thumb-change');
    } else {
      this.findTopicThumbnail(++index);
    }
  }
});

</script>