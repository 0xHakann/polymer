<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../polymer/data.html">

<link rel="import" href="../../../elements/x-icon.html">
<link rel="import" href="../../../elements/x-icon-button.html">
<link rel="import" href="../../../elements/x-repeater.html">
<link rel="import" href="../../../elements/x-selector.html">
<link rel="import" href="../../../elements/x-pages.html">
<link rel="import" href="../../../elements/x-drawer-panel2.html">
<link rel="import" href="../../../elements/x-toolbar.html">
<link rel="import" href="../../../elements/x-media-query.html">
<link rel="import" href="../../../elements/x-drop-button.html">
<link rel="import" href="../../../elements/x-overlay.html">

<link rel="import" href="../elements/pi-topic-item.html">
<link rel="import" href="../elements/pi-item.html">

<template>

  <x-drawer-panel2 id="drawerPanel" flex>
  
    <div drawer vertical layout>

      <x-toolbar>
        <span>Pica</span>
      </x-toolbar>
      <x-toolbar bottom></x-toolbar>

      <div flex scroll>
        <x-selector selectable="item" index="1" menu on-click="closeDrawerAction">
          <item><x-icon icon="explore"></x-icon>Home</item>
          <item on-click="topicsAction"><x-icon icon="view-module"></x-icon>Topics</item>
          <item><x-icon icon="explore"></x-icon>Explore</item>
          <item><x-icon icon="account-box"></x-icon>Accounts</item>
        </x-selector>
      </div>

    </div>

    <x-pages main vertical layout selected="{{page}}">

      <div id="main" flex vertical layout>

        <x-toolbar>
          <x-icon-button icon="menu" x-drawer-toggle></x-icon-button>
          <span flex>Topics</span>
          <x-icon-button icon="refresh" on-click="topicsAction"></x-icon-button>
        </x-toolbar>
        <x-toolbar bottom></x-toolbar>

        <div flex scroll>
          <x-selector id="topicsSelector" selectable="pi-topic-item" on-click="topicAction">
            <x-repeater id="topics" kind="pi-topic-item" items="{{topics}}" on-feed-load="topicLoaded"></x-repeater>
          </x-selector>
        </div>

      </div>

      <div id="topic" flex vertical layout>

        <x-toolbar>
          <x-icon-button icon="back" on-click="topicsAction"></x-icon-button>
          <span flex>{{topic.title}}</span>
          <x-icon-button icon="view-quilt" active="{{quilt}}" on-click="toggleLayoutAction"></x-icon-button>
          <x-icon-button icon="refresh" on-click="refreshTopic"></x-icon-button>
          <x-drop-button icon="more-vert" halign="right">
            <x-overlay id="dropdown" menu on-click="closeDropdown">
              <item><x-icon icon="create"></x-icon>Post a Comment</item>
              <item><x-icon icon="share"></x-icon>Share Link</item>
              <item><x-icon icon="mail"></x-icon>Email Link</item>
              <item><x-icon icon="favorite"></x-icon>Add to Favorites</item>
            </x-overlay>
          </x-drop-button>
        </x-toolbar>
        <x-toolbar bottom></x-toolbar>

        <div flex scroll>
          <x-selector id="articlesSelector" selectable="pi-item" on-click="articleAction">
            <x-repeater id="articles" kind="pi-item" items="{{items}}"></x-repeater>
          </x-selector>
        </div>

      </div>

      <div id="article" flex vertical layout>

        <x-toolbar>
          <x-icon-button icon="back" on-click="topicAction"></x-icon-button>
          <span flex>{{topic.title}}</span>
          <span relative>
            <x-icon-button icon="launch"></x-icon-button>
            <a href="{{article.link}}" target="_blank" fit></a>
          </span>
        </x-toolbar>
        <x-toolbar bottom></x-toolbar>

        <div class="main-outer" flex scroll>
          <div id="articleMain">
            <div class="title">{{article.title}}</div>
            <div class="info">{{articleInfo}}</div>
            <div id="content"></div>
          </div>
        </div>

      </div>

    </x-pages>

  </x-drawer-panel2>
  
  <x-media-query query="max-width: 450px" on-media-change="mediaChange"></x-media-query>

</template>

<script>

(function() {
  
  Polymer({
    name: 'pi-app',
    hostAttributes: 'horizontal layout',
    bind: {
      quilt: 'quiltChanged'
    },
    computed: {
      articleInfo: 'computeArticleInfo(article)'
    },
    created: function() {
      this.page = 0;
      this.topics = topics;
      this.quilt = false;
    },
    closeDrawerAction: function() {
      this.$.drawerPanel.closeDrawer();
    },
    topicsAction: function() {
      this.page = 0;
      this.animatize(this.$.topics);
    },
    topicAction: function() {
      this.topicNode = this.$.topicsSelector.selected;
      this.topic = this.topicNode.item;
      this.items = this.topic.items;
      this.page = 1;
      this.animatize(this.$.articles);
    },
    refreshTopic: function() {
      this.topicNode.refresh();
    },
    topicLoaded: function(e) {
      var topic = e.detail;
      if (this.topic && this.topic.title === topic.title) {
        this.items = topic.items;
        this.animatize(this.$.articles);
      }
    },
    articleAction: function() {
      this.article = this.$.articlesSelector.selected.item;
      var content = this.article.content;
      if (content) {
        this.$.content.innerHTML = 
          content.replace(/(<iframe.*?>.*?<\/iframe>)/g, '');
      }
      this.page = 2;
      this.animatize(this.$.articleMain);
    },
    computeArticleInfo: function(article) {
      return 'by ' + article.author + ' on ' + article.publishedDate;
    },
    closeDropdown: function() {
      this.$.dropdown.close();
    },
    toggleLayoutAction: function() {
      this.quilt = !this.quilt;
      this.topicAction();
    },
    quiltChanged: function() {
      this.$.topic.classList.toggle(this.narrow ? 'list' : 'quilt', this.quilt);
    },
    mediaChange: function(e) {
      this.narrow = e.detail.matches;
    },
    animatize: function(container) {
      var a$ = container;
      a$.className = '';
      for (var i=0, c=a$.firstElementChild; c; c=c.nextElementSibling, i++) {
        c.style.transform = c.style.webkitTransform =
            'translate3d(0,' + (Math.pow(i, 2.2)*3 + 50) + 'px,0)';
      }
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          a$.className = 'animate';
          for (var c=a$.firstElementChild; c; c=c.nextElementSibling) {
            c.style.transform = c.style.webkitTransform = '';
          }
        });
      });
    }
  });

  var topics = [
    {title: 'Technology', feed: 'http://www.theverge.com/rss/index.xml'},
    {title: 'Sports', feed: 'http://feeds.gawker.com/deadspin/full'},
    {title: 'Music', feed: 'http://feeds.feedburner.com/indieshuffle'},
    {title: 'Art', feed: 'http://feeds.feedburner.com/wooster'},
    {title: 'Fashion', feed: 'http://feeds.feedburner.com/hypebeast/feed'},
    {title: 'Architecture', feed: 'http://feeds.feedburner.com/dezeen'},
    {title: 'Design', feed: 'http://feeds.feedburner.com/design-milk'},
    {title: 'Food', feed: 'http://feeds.thekitchn.com/apartmenttherapy/thekitchn'}
  ];
  
})();

</script>
