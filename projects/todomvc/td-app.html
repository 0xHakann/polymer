<template>

  <header id="header">
    <h1>todos</h1>
    <input id="newTodo" placeholder="What needs to be done?">
  </header>

  <div id="main">

    <input id="toggleAll" type="checkbox">

    <div id="list" class="todo-list"></div>

    <footer id="footer">

      <span id="leftText" class="todo-count"></span>

      <radiogroup id="filters">
        <label><input type="radio" name="filter" id="all" checked><span>All</span></label>
        <label><input type="radio" name="filter" id="active"><span>Active</span></label>
        <label><input type="radio" name="filter" id="completed"><span>Completed</span></label>
      </radiogroup>

      <button id="clearButton">Clear completed (<span id="clearCount"></span>)</button>

    </footer>

  </div>

</template>

<script>

  Polymer({

    name: 'td-app',
    hostAttributes: 'block',
    filter: 'all',

    listeners: {
      'filters.change': 'filterChange',
      'list.item-change': 'itemChange',
      'list.item-remove': 'itemRemove',
      'clearButton.click': 'clearCompleted',
      'toggleAll.click': 'toggleAllCompleted'
    },

    keyPresses: {
      ENTER_KEY: 'itemAdd'
    },

    created: function() {
      this.items = [
        {value: 'Extend the web', completed: true},
        {value: 'Dethrone native apps'}, 
        {value: 'Party'}
      ];
      this.render();
    },

    render: function() {
      var completed = this.renderFilteredItems(this.items, 
        this.filters[this.filter]);
      this.$.leftText.textContent = 
        this.computeLeftText(this.items, completed); 
      this.$.clearButton.hidden = this.computeClearHidden(completed);
      this.$.clearCount.textContent = completed;
      this.$.toggleAll.checked = !this.computeLeft(this.items, completed);
      this.$.main.hidden = !this.items.length;
    },

    renderFilteredItems: function(items, filter) {
      var completed = 0;
      this.$.list.textContent = '';
      items.forEach(function(i) {
        completed += i.completed ? 1 : 0;
        if (!filter || filter(i)) {
          this.addTodoElement(i);
        }
      }, this);
      return completed;
    },
    
    addTodoElement: function(item) {
      this.$.list.appendChild(new TdToDo(item));
    },

    computeLeftText: function(items, completed) {
      var left = this.computeLeft(items, completed);
      return (left === 1 ? '1 item' : left + ' items') + ' left';
    },

    computeLeft: function(items, completed) {
      return items.length - completed;
    },

    computeClearHidden: function(completed) {
      return completed === 0;
    },

    // signal handlers
    
    itemChange: function(e) {
      this.render();
    },

    itemRemove: function(e) {
      var index = this.items.indexOf(e.target.item);
      if (index >= 0) {
        this.items.splice(index, 1);
        this.render();
      }  
    },

    itemAdd: function(e) {
      if (this.$.newTodo.value) {
        this.items.push({value: this.$.newTodo.value});
        this.$.newTodo.value = '';
        this.render();
      }
    },

    clearCompleted: function() {
      this.items = this.items.filter(this.filters.active);
      this.render();
    },

    toggleAllCompleted: function(e) {
      var completed = e.target.checked;
      this.items.forEach(function(item) {
        item.completed = completed;
      });
      this.render();
    },

    filterChange: function(e) {
      this.filter = e.target.id;
      this.render();
    },

    // statics 

    filters: {
      active: function(item) {
        return !item.completed;
      },
      completed: function(item) {
        return item.completed;
      }
    }

  });

</script>
